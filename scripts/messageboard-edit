#!/usr/bin/env nu
# messageboard-edit - Atomic MESSAGEBOARD.md editing
# Bypasses Claude Code Edit tool's race condition by using direct file operations
#
# Usage: messageboard-edit insert "message content"
#        messageboard-edit remove-section "### 2026-01-11 — device"
#        messageboard-edit show

def main [action: string, content?: string] {
    let file = $"($env.HOME)/Assistants/shared/MESSAGEBOARD.md"
    let device = (sys host | get hostname)
    let date = (date now | format date "%Y-%m-%d")

    match $action {
        "insert" => {
            if ($content | is-empty) {
                print "Error: message content required"
                return
            }

            # Read current content
            let current = (open $file)

            # Find insertion point (after "## Messages" line)
            let lines = ($current | lines)
            let insert_idx = ($lines | enumerate | where {|x| $x.item == "## Messages"} | first | get index) + 1

            # Build new message
            let header = $"### ($date) — ($device)"
            let new_message = $"($header)\n\n($content)\n\n---\n"

            # Insert message
            let before = ($lines | first ($insert_idx + 1) | str join "\n")
            let after = ($lines | skip ($insert_idx + 1) | str join "\n")
            let updated = $"($before)\n\n($new_message)\n($after)"

            # Write atomically
            $updated | save -f $file
            print $"✅ Message inserted at ($date) — ($device)"
        }

        "remove-section" => {
            if ($content | is-empty) {
                print "Error: section header required (e.g., '### 2026-01-11 — mac')"
                return
            }

            let current = (open $file)
            let lines = ($current | lines)

            # Find the section start
            let start_idx = try {
                $lines | enumerate | where {|x| $x.item | str starts-with $content} | first | get index
            } catch {
                print $"Section not found: ($content)"
                return
            }

            # Find next section (next ### or end)
            let end_idx = try {
                let remaining = ($lines | skip ($start_idx + 1) | enumerate)
                let next = ($remaining | where {|x| $x.item | str starts-with "###"} | first | get index)
                $start_idx + 1 + $next
            } catch {
                $lines | length
            }

            # Also remove the --- before the section if present
            let actual_start = if $start_idx > 0 and ($lines | get ($start_idx - 1)) == "---" {
                $start_idx - 1
            } else {
                $start_idx
            }

            # Reconstruct without the section
            let before = ($lines | first $actual_start | str join "\n")
            let after = ($lines | skip $end_idx | str join "\n")
            let updated = $"($before)\n($after)"

            $updated | save -f $file
            print $"✅ Removed section: ($content)"
        }

        "show" => {
            open $file | print
        }

        _ => {
            print "Usage:"
            print "  messageboard-edit insert \"message\""
            print "  messageboard-edit remove-section \"### 2026-01-11 — device\""
            print "  messageboard-edit show"
        }
    }
}
