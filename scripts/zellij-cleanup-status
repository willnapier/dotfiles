#!/usr/bin/env bash
# Show Zellij zombie cleanup system status

LOGFILE="$HOME/.local/share/zellij-cleanup.log"

echo "ü§ñ Zellij Zombie Cleanup Status"
echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"

# Check if cron job is running
echo "üìÖ Cron Job:"
if crontab -l | grep -q zellij-auto-cleanup; then
    echo "‚úÖ Installed (every 15 minutes)"
    crontab -l | grep zellij-auto-cleanup | sed 's/^/  /'
else
    echo "‚ùå Not found in crontab"
fi

echo ""

# Check launch agent
echo "üöÄ Launch Agent:"
if launchctl list | grep -q com.user.zellij-cleanup; then
    echo "‚úÖ Running (every 15 minutes)"
else
    echo "‚ùå Not loaded"
fi

echo ""

# Show recent cleanup activity
echo "üìä Recent Activity:"
if [[ -f "$LOGFILE" ]]; then
    echo "  Last 10 cleanup events:"
    tail -10 "$LOGFILE" | sed 's/^/  /'
    echo ""
    echo "  Total cleanups today:"
    TODAY=$(date '+%Y-%m-%d')
    CLEANUPS_TODAY=$(grep "$TODAY" "$LOGFILE" 2>/dev/null | grep -c "Cleaned:" || echo "0")
    echo "  $CLEANUPS_TODAY zombie sessions removed"
else
    echo "  No activity log found yet"
fi

echo ""

# Current Zellij status
echo "üîç Current Status:"
PROCESS_COUNT=$(ps aux | grep -i zellij | grep -v grep | wc -l | tr -d ' ')
ZOMBIE_COUNT=$(zellij list-sessions --no-formatting 2>/dev/null | grep "EXITED" | wc -l | tr -d ' ')
echo "  Running Zellij processes: $PROCESS_COUNT"
echo "  Zombie sessions: $ZOMBIE_COUNT"

if [[ "$ZOMBIE_COUNT" -gt 0 ]]; then
    echo "  ‚ö†Ô∏è  Zombies will be cleaned at next 15-minute interval"
else
    echo "  ‚úÖ No zombies detected"
fi