#!/opt/homebrew/bin/nu
# Assistants Auto-Push for macOS - Automatically commits and pushes ~/Assistants changes

def main [] {
    let assistants_dir = $"($env.HOME)/Assistants"
    let log_file = $"($env.HOME)/.local/share/assistants-auto-push.log"
    let lock_file = "/tmp/assistants-auto-push.lock"
    let last_push = "/tmp/assistants-last-push"

    # Ensure log directory exists
    mkdir ($log_file | path dirname)

    # Smart lock file handling with stale lock detection
    if ($lock_file | path exists) {
        let lock_age = ((date now) - (ls $lock_file | get 0.modified))
        let age_minutes = ($lock_age / 1min)

        if $age_minutes > 10 {
            let timestamp = (date now | format date "%H:%M:%S")
            let cleanup_msg = $"[($timestamp)] Cleaning up stale lock file"
            $cleanup_msg | save --append $log_file
            print $cleanup_msg
            rm -f $lock_file
        } else {
            print "âŒ Assistants auto-push already running (recent lock file)"
            exit 1
        }
    }

    # Create lock file
    "running" | save --force $lock_file

    print "ğŸš€ Starting Assistants auto-push watcher (macOS)"
    print $"ğŸ‘€ Watching: ($assistants_dir)"
    print $"ğŸ“ Logging to: ($log_file)"

    # Initial push timestamp
    (date now | format date "%s") | save --force $last_push

    # Check for uncommitted changes every 2 minutes
    loop {
        sleep 2min

        cd $assistants_dir

        # Check for uncommitted changes
        let status_result = (do { git status --porcelain } | complete)

        if $status_result.exit_code == 0 and not ($status_result.stdout | is-empty) {
            let now = (date now | format date "%s" | into int)
            let last = (try { open $last_push | into int } catch { 0 })
            let elapsed = $now - $last

            # Debounce - only push once every 2 minutes
            if $elapsed > 120 {
                let timestamp = (date now | format date "%H:%M:%S")
                let message = $"[($timestamp)] Assistants changes detected - auto-pushing"
                $message | save --append $log_file
                print $message

                # Auto-commit and push changes
                print "ğŸ“¤ Auto-committing and pushing changes..."

                let add_result = (do { git add . } | complete)
                if $add_result.exit_code == 0 {
                    # Note: Using string concat to avoid Nushell interpreting parens as commands
                    let platform_tag = "(Mac)"
                    let commit_msg = [$"Auto-sync: Documentation updates ($platform_tag)" "" "Co-Authored-By: Claude <noreply@anthropic.com>"] | str join (char newline)

                    let commit_result = (do { git commit -m $commit_msg } | complete)
                    if $commit_result.exit_code == 0 {
                        let push_result = (do { git push origin main } | complete)
                        if $push_result.exit_code == 0 {
                            let success_msg = $"[($timestamp)] âœ… Successfully pushed Assistants changes to GitHub"
                            $success_msg | save --append $log_file
                            print "âœ… Changes pushed to GitHub!"
                        } else {
                            let error_msg = $"[($timestamp)] âŒ Push failed: ($push_result.stderr)"
                            $error_msg | save --append $log_file
                            print $"âŒ Push failed: ($push_result.stderr)"
                        }
                    } else {
                        # No changes to commit (might be only untracked files)
                        let no_changes_msg = $"[($timestamp)] â„¹ï¸ No changes to commit"
                        $no_changes_msg | save --append $log_file
                    }
                } else {
                    let error_msg = $"[($timestamp)] âŒ Git add failed: ($add_result.stderr)"
                    $error_msg | save --append $log_file
                    print $"âŒ Git add failed: ($add_result.stderr)"
                }

                # Update last push time
                (date now | format date "%s") | save --force $last_push
            }
        }
    }

    # Cleanup on exit
    rm -f $lock_file
    print "ğŸ›‘ Assistants auto-push watcher stopped"
}
