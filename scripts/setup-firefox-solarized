#!/usr/bin/env bash
# Setup Solarized theme for Firefox with automatic switching
# Works on both macOS and Linux

set -e

echo "🦊 Firefox Solarized Theme Setup"
echo "================================"
echo ""

# Detect platform
if [[ "$OSTYPE" == "darwin"* ]]; then
    PLATFORM="macOS"
    FIREFOX_APP="/Applications/Firefox.app/Contents/MacOS/firefox"
elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
    PLATFORM="Linux"
    FIREFOX_APP="firefox"
else
    echo "❌ Unsupported platform: $OSTYPE"
    exit 1
fi

echo "🖥️  Platform: $PLATFORM"
echo ""

# Function to open Firefox with a specific URL
open_firefox_url() {
    local url="$1"
    echo "📂 Opening: $url"

    if [[ "$PLATFORM" == "macOS" ]]; then
        open -a Firefox "$url" 2>/dev/null || open "$url"
    else
        firefox "$url" &>/dev/null &
    fi

    sleep 2
}

# Check if Firefox is installed
if [[ "$PLATFORM" == "macOS" ]]; then
    if [[ ! -d "/Applications/Firefox.app" ]]; then
        echo "❌ Firefox not found. Please install Firefox first."
        exit 1
    fi
else
    if ! command -v firefox &> /dev/null; then
        echo "❌ Firefox not found. Please install Firefox first."
        exit 1
    fi
fi

echo "✅ Firefox is installed"
echo ""

# Platform-specific recommendations
if [[ "$PLATFORM" == "macOS" ]]; then
    echo "🍎 macOS Detected - System theme integration available"
    echo ""
    echo "📋 Theme Options:"
    echo ""
    echo "1. Zenfox - Dynamic Solarized (Recommended for macOS)"
    echo "   • Auto-switches based on macOS system theme ✅"
    echo "   • Manual toggle via toolbar button"
    echo "   • Time-based switching option"
    echo "   • Weather-based switching (!)"
    echo ""
    echo "2. Solarized Light/Dark Auto"
    echo "   • Follows macOS system preferences ✅"
    echo "   • Simple, no configuration needed"
    echo ""
    echo "3. Individual Themes (Manual)"
    echo "   • Solarized Light only"
    echo "   • Solarized Dark only"
    echo "   • No automatic switching"
    echo ""
else
    echo "🐧 Linux Detected - No unified system theme API"
    echo ""
    echo "⚠️  NOTE: Linux doesn't have a standard 'system theme' that Firefox can follow."
    echo "    Theme switching will be manual or time-based."
    echo ""
    echo "📋 Theme Options:"
    echo ""
    echo "1. Zenfox - Dynamic Solarized (Best for Linux)"
    echo "   • Time-based switching (set day/night times) ⭐"
    echo "   • Manual toggle via toolbar button ⭐"
    echo "   • Weather-based switching (requires location)"
    echo "   ❌ System mode won't work reliably on Linux"
    echo ""
    echo "2. Individual Dark Theme (Recommended if you prefer dark)"
    echo "   • Solarized Dark only"
    echo "   • Consistent appearance"
    echo "   • No switching needed"
    echo ""
    echo "3. Individual Light Theme (If you prefer light)"
    echo "   • Solarized Light only"
    echo "   • Consistent appearance"
    echo "   • No switching needed"
    echo ""
    echo "4. Both Individual Themes (Manual switching)"
    echo "   • Install both Light and Dark"
    echo "   • Switch manually in Firefox settings"
    echo ""
fi

# Prompt for choice based on platform
if [[ "$PLATFORM" == "macOS" ]]; then
    read -p "Select option (1-3) [1]: " choice
    choice=${choice:-1}
else
    read -p "Select option (1-4) [1]: " choice
    choice=${choice:-1}
fi

case $choice in
    1)
        echo ""
        echo "🎨 Installing Zenfox - Dynamic Solarized Theme"
        echo ""

        if [[ "$PLATFORM" == "Linux" ]]; then
            echo "⚠️  IMPORTANT for Linux:"
            echo "   • Use 'Time' mode (not 'System' mode)"
            echo "   • Set your preferred light/dark schedule"
            echo "   • Or use manual toolbar button to switch"
            echo ""
        fi

        echo "This will open Firefox to the addon page."
        echo "Click 'Add to Firefox' to install."
        echo ""
        read -p "Press Enter to continue..."

        # Open Zenfox addon page
        open_firefox_url "https://addons.mozilla.org/en-US/firefox/addon/zen-fox/"

        echo ""
        echo "📝 After installation:"
        if [[ "$PLATFORM" == "macOS" ]]; then
            echo "1. Click the Zenfox icon in the toolbar"
            echo "2. Select 'System' mode for automatic switching"
            echo "3. Theme will follow macOS appearance settings"
        else
            echo "1. Click the Zenfox icon in the toolbar"
            echo "2. Select 'Time' mode"
            echo "3. Set your preferred schedule (e.g., 7am light, 7pm dark)"
            echo "4. Or use 'Manual' mode and toggle with toolbar button"
        fi
        echo ""
        ;;

    2)
        if [[ "$PLATFORM" == "macOS" ]]; then
            echo ""
            echo "🎨 Installing Solarized Light/Dark Auto"
            echo ""
            echo "This will open Firefox to the addon page."
            echo "Click 'Add to Firefox' to install."
            echo ""
            read -p "Press Enter to continue..."

            # Open auto-switching theme page
            open_firefox_url "https://addons.mozilla.org/en-US/firefox/addon/solarized-light-dark/"

            echo ""
            echo "📝 Theme will automatically switch based on macOS system preferences"
            echo ""
        else
            echo ""
            echo "🎨 Installing Solarized Dark Theme"
            echo ""
            echo "This will open Firefox to the addon page."
            echo "Click 'Add to Firefox' to install."
            echo ""
            read -p "Press Enter to continue..."

            # Open dark theme page for Linux
            open_firefox_url "https://addons.mozilla.org/en-US/firefox/addon/sol-dark/"

            echo ""
            echo "📝 Dark theme installed - no switching needed"
            echo ""
        fi
        ;;

    3)
        if [[ "$PLATFORM" == "macOS" ]]; then
            echo ""
            echo "🎨 Installing Individual Solarized Themes"
            echo ""
            echo "This will open both Light and Dark theme pages."
            echo "Install one or both as desired."
            echo ""
            read -p "Press Enter to continue..."

            # Open both theme pages
            open_firefox_url "https://addons.mozilla.org/en-US/firefox/addon/solarized-light-theme/"
            sleep 3
            open_firefox_url "https://addons.mozilla.org/en-US/firefox/addon/sol-dark/"

            echo ""
            echo "📝 Switch themes manually via Firefox settings"
            echo ""
        else
            echo ""
            echo "🎨 Installing Solarized Light Theme"
            echo ""
            echo "This will open Firefox to the addon page."
            echo "Click 'Add to Firefox' to install."
            echo ""
            read -p "Press Enter to continue..."

            # Open light theme page for Linux
            open_firefox_url "https://addons.mozilla.org/en-US/firefox/addon/solarized-light-theme/"

            echo ""
            echo "📝 Light theme installed - no switching needed"
            echo ""
        fi
        ;;

    4)
        if [[ "$PLATFORM" == "Linux" ]]; then
            echo ""
            echo "🎨 Installing Both Individual Themes"
            echo ""
            echo "This will open both Light and Dark theme pages."
            echo "Install both to enable manual switching."
            echo ""
            read -p "Press Enter to continue..."

            # Open both theme pages
            open_firefox_url "https://addons.mozilla.org/en-US/firefox/addon/solarized-light-theme/"
            sleep 3
            open_firefox_url "https://addons.mozilla.org/en-US/firefox/addon/sol-dark/"

            echo ""
            echo "📝 Switch themes manually:"
            echo "   Firefox Menu → Add-ons → Themes"
            echo ""
        fi
        ;;

    *)
        echo "❌ Invalid choice"
        exit 1
        ;;
esac

echo "🔧 Additional Setup:"
echo ""

if [[ "$PLATFORM" == "macOS" ]]; then
    echo "macOS Integration:"
    echo "• System Preferences → Appearance → Auto (light/dark)"
    echo "• Firefox will follow system theme changes"
    echo "• Your hx-auto theme detection will sync with this!"
    echo ""
else
    echo "Linux Considerations:"
    echo "• No automatic system theme detection"
    echo "• Best option: Zenfox with time-based switching"
    echo "• Alternative: Pick your preferred theme (light or dark)"
    echo "• For Niri/Wayland: Theme must be set within Firefox"
    echo ""
    echo "💡 TIP: If you mostly work in dark environments, just use"
    echo "   Solarized Dark and keep it consistent."
fi

echo ""
echo "🎯 Cross-Platform Strategy:"
echo ""
echo "Recommended setup for your workflow:"
echo "• macOS: Zenfox or Auto theme (follows system)"
echo "• Linux: Zenfox with time-based switching"
echo "         OR consistent dark theme"
echo ""

# Create a reference file for documentation
cat > /tmp/firefox-solarized-setup.md << 'EOF'
# Firefox Solarized Theme Setup

## Installed Theme
EOF

case $choice in
    1) echo "Zenfox - Dynamic Solarized Theme" >> /tmp/firefox-solarized-setup.md ;;
    2)
        if [[ "$PLATFORM" == "macOS" ]]; then
            echo "Solarized Light/Dark Auto" >> /tmp/firefox-solarized-setup.md
        else
            echo "Solarized Dark Theme" >> /tmp/firefox-solarized-setup.md
        fi
        ;;
    3)
        if [[ "$PLATFORM" == "macOS" ]]; then
            echo "Individual Solarized Light and Dark Themes" >> /tmp/firefox-solarized-setup.md
        else
            echo "Solarized Light Theme" >> /tmp/firefox-solarized-setup.md
        fi
        ;;
    4) echo "Both Individual Solarized Themes (Light and Dark)" >> /tmp/firefox-solarized-setup.md ;;
esac

cat >> /tmp/firefox-solarized-setup.md << EOF

## Platform: $PLATFORM
## Date: $(date "+%Y-%m-%d")

## Configuration Notes
EOF

if [[ "$PLATFORM" == "macOS" ]]; then
    cat >> /tmp/firefox-solarized-setup.md << EOF
- Theme follows macOS system appearance settings
- Automatic switching between light/dark modes
- Syncs with terminal and editor themes via system API
EOF
else
    cat >> /tmp/firefox-solarized-setup.md << EOF
- Linux has no unified system theme API
- Using time-based or manual switching
- Consistent with chosen terminal/editor theme
EOF
fi

cat >> /tmp/firefox-solarized-setup.md << EOF

## URLs for Manual Installation
- Zenfox: https://addons.mozilla.org/en-US/firefox/addon/zen-fox/
- Auto Light/Dark (macOS): https://addons.mozilla.org/en-US/firefox/addon/solarized-light-dark/
- Light Only: https://addons.mozilla.org/en-US/firefox/addon/solarized-light-theme/
- Dark Only: https://addons.mozilla.org/en-US/firefox/addon/sol-dark/

## Platform-Specific Notes
EOF

if [[ "$PLATFORM" == "macOS" ]]; then
    cat >> /tmp/firefox-solarized-setup.md << EOF
### macOS
- System theme integration works perfectly
- Firefox respects macOS appearance settings
- Zenfox 'System' mode recommended
- Integrates with hx-auto theme detection
EOF
else
    cat >> /tmp/firefox-solarized-setup.md << EOF
### Linux
- No standard system theme API
- Zenfox 'Time' mode recommended for auto-switching
- Alternative: Choose consistent dark or light theme
- Manual switching always available
- Desktop environment theme settings don't affect Firefox
EOF
fi

echo "📄 Setup notes saved to: /tmp/firefox-solarized-setup.md"
echo ""
echo "✅ Firefox Solarized theme setup complete!"
echo ""
echo "Run this script on your other platform for the best setup there."