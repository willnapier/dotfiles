#!/usr/bin/env nu

# Modernization Guard - Prevents legacy command regressions
# Scans critical files for patterns that cause actual failures

def main [] {
    let critical_patterns = [
        {
            pattern: "2>/dev/null",
            files: ["nushell/*.nu", "scripts/*.nu"],
            message: "❌ Bash redirection in Nushell - use | complete"
        },
        {
            pattern: "\\bsed\\b",
            files: ["scripts/*"],
            message: "❌ Legacy sed command - use sd instead"
        },
        {
            pattern: "\\bgrep\\b -",
            files: ["scripts/*"],
            message: "❌ Legacy grep command - use rg instead"
        }
    ]

    mut issues_found = false

    for pattern_info in $critical_patterns {
        for file_glob in $pattern_info.files {
            let matches = (try {
                rg $pattern_info.pattern $file_glob -l 2>/dev/null
            } catch { "" } | str trim)

            if ($matches | str length) > 0 {
                print $pattern_info.message
                print $"Files: ($matches)"
                print ""
                $issues_found = true
            }
        }
    }

    if not $issues_found {
        print "✅ All critical files are modernized"
    }
}