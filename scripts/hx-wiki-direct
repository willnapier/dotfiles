#!/usr/bin/env bash
# Direct wiki link navigation for Helix - outputs actual file path
# No symlinks, just returns the real file path for Helix to open

line=$(cat)

# Extract wiki link from line
link=$(echo "$line" | rg -o '\[\[([^\]]+)\]\]' -r '$1' | head -1)

if [ -z "$link" ]; then
    # No wiki link found
    exit 1
fi

# Clean the link
clean_link=$(echo "$link" | sd '[#|].*' '')

vault="$HOME/Forge"
daily_dir="$vault/NapierianLogs/DayPages"

# First, search for existing file anywhere in the vault - exact match
existing_file=$(fd -t f "^$clean_link\.md$" "$vault" 2>/dev/null | head -1)
if [ -n "$existing_file" ]; then
    # Found exact match - output the path
    echo "$existing_file"
    exit 0
fi

# Check for daily note format
if [[ "$clean_link" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
    file="$daily_dir/$clean_link.md"
else
    # Regular note - determine path
    if [[ "$clean_link" == *.* ]]; then
        file="$vault/$clean_link"
    else
        file="$vault/$clean_link.md"
    fi
fi

# If file doesn't exist, create it
if [ ! -f "$file" ]; then
    mkdir -p "$(dirname "$file")"

    # Create basic file with H1 and backlinks section
    title=$(basename "$file" .md)
    cat > "$file" << EOF
# $title

## Backlinks

<!-- BACKLINKS:START -->
<!-- BACKLINKS:END -->
EOF
fi

# Output the actual file path
echo "$file"