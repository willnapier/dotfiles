#!/usr/bin/env nu
# Switch between different Goose model configurations
# Usage: goose-switch-model [haiku|openrouter|status]

def main [
    profile?: string  # Profile to switch to: haiku, openrouter, or status
] {
    let config_dir = $"($env.HOME)/.config/goose"
    let active_config = $"($config_dir)/config.yaml"

    # If no argument, show current status
    if ($profile | is-empty) or ($profile == "status") {
        print "üîç Current Goose Configuration:"
        print ""

        if not ($active_config | path exists) {
            print "‚ùå No active config found"
            return
        }

        let provider = (open $active_config | get GOOSE_PROVIDER? | default "unknown")
        let model = (open $active_config | get GOOSE_MODEL? | default "unknown")

        print $"Provider: ($provider)"
        print $"Model: ($model)"
        print ""
        print "Available profiles:"
        print "  ‚Ä¢ haiku      - Claude Haiku 4.5 via Anthropic"
        print "  ‚Ä¢ openrouter - Google Gemini 2.0 Flash via OpenRouter (free, US-hosted, fast)"
        print ""
        print "Usage: goose-switch-model [haiku|openrouter]"
        return
    }

    # Switch to requested profile
    match $profile {
        "haiku" => {
            let source = $"($config_dir)/config-haiku.yaml"
            if not ($source | path exists) {
                print $"‚ùå Error: ($source) not found"
                return
            }
            cp $source $active_config
            print "‚úÖ Switched to Haiku 4.5 (Anthropic)"
            print "   Model: claude-haiku-4-5-20251001"
            print "   Cost: $1/$5 per MTok"
        }
        "openrouter" => {
            let source = $"($config_dir)/config-openrouter.yaml"
            if not ($source | path exists) {
                print $"‚ùå Error: ($source) not found"
                return
            }

            # Check if OpenRouter API key is set
            if ($env.OPENROUTER_API_KEY? | is-empty) {
                print "‚ö†Ô∏è  Warning: OPENROUTER_API_KEY not set in environment"
                print "   Get your key at: https://openrouter.ai/keys"
                print "   Add to ~/.config/nushell/env.nu:"
                print '   $env.OPENROUTER_API_KEY = "sk-or-v1-..."'
                print ""
            }

            cp $source $active_config
            print "‚úÖ Switched to Google Gemini 2.0 Flash (OpenRouter)"
            print "   Model: google/gemini-2.0-flash-exp:free"
            print "   Cost: FREE (US-hosted, fast responses)"
        }
        _ => {
            print $"‚ùå Unknown profile: ($profile)"
            print ""
            print "Available profiles:"
            print "  ‚Ä¢ haiku      - Claude Haiku 4.5 via Anthropic"
            print "  ‚Ä¢ openrouter - Google Gemini 2.0 Flash via OpenRouter (free, US-hosted, fast)"
        }
    }
}
