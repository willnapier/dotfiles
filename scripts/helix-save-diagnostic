#!/usr/bin/env nu

# Helix Save System Diagnostic
# Investigates exactly what happens when Helix "saves" files

def main [file_path: string] {
    print $"ğŸ” HELIX SAVE DIAGNOSTIC: ($file_path)"
    print "=================================================="
    
    # Get baseline file info
    let initial_stat = (stat $file_path)
    print $"ğŸ“Š Initial file size: ($initial_stat.size) bytes"
    print $"ğŸ“Š Initial modified time: ($initial_stat.modified)"
    
    # Check initial content
    print "ğŸ“„ Initial file content (last 3 lines):"
    ^tail -3 $file_path | each { |line| print $"   ($line)" }
    
    print "\nâ° Waiting 1 second..."
    sleep 1sec
    
    # Check if file changed
    let after_1sec_stat = (stat $file_path)
    print $"ğŸ“Š After 1sec - size: ($after_1sec_stat.size), modified: ($after_1sec_stat.modified)"
    
    if $after_1sec_stat.modified != $initial_stat.modified {
        print "ğŸ”„ FILE CHANGED during first second!"
        print "ğŸ“„ New content (last 3 lines):"
        ^tail -3 $file_path | each { |line| print $"   ($line)" }
    } else {
        print "ğŸ’¤ No change detected in first second"
    }
    
    print "\nâ° Waiting another 2 seconds..."
    sleep 2sec
    
    # Check again
    let after_3sec_stat = (stat $file_path)
    print $"ğŸ“Š After 3sec - size: ($after_3sec_stat.size), modified: ($after_3sec_stat.modified)"
    
    if $after_3sec_stat.modified != $after_1sec_stat.modified {
        print "ğŸ”„ FILE CHANGED during second wait!"
        print "ğŸ“„ New content (last 3 lines):"
        ^tail -3 $file_path | each { |line| print $"   ($line)" }
    } else {
        print "ğŸ’¤ No change detected in second wait"
    }
    
    print "\nâ° Waiting another 5 seconds..."
    sleep 5sec
    
    # Final check
    let final_stat = (stat $file_path)
    print $"ğŸ“Š Final - size: ($final_stat.size), modified: ($final_stat.modified)"
    
    if $final_stat.modified != $after_3sec_stat.modified {
        print "ğŸ”„ FILE CHANGED during final wait!"
        print "ğŸ“„ Final content (last 3 lines):"
        ^tail -3 $file_path | each { |line| print $"   ($line)" }
    } else {
        print "ğŸ’¤ No change detected in final wait"
    }
    
    print "\nğŸ” FILESYSTEM BUFFER CHECK:"
    print "Running sync command to flush any OS-level buffers..."
    ^sync
    
    let post_sync_stat = (stat $file_path)
    if $post_sync_stat.modified != $final_stat.modified {
        print "ğŸš¨ FILE CHANGED AFTER SYNC! This indicates OS-level buffering."
        print "ğŸ“„ Post-sync content (last 3 lines):"
        ^tail -3 $file_path | each { |line| print $"   ($line)" }
    } else {
        print "âœ… No change after sync - file is consistent"
    }
    
    print "\nğŸ“‹ DIAGNOSTIC SUMMARY:"
    print $"   Initial size: ($initial_stat.size) â†’ Final size: ($post_sync_stat.size)"
    print $"   Time span: ($initial_stat.modified) â†’ ($post_sync_stat.modified)"
    
    if $initial_stat.size != $post_sync_stat.size {
        print "ğŸš¨ SIZE CHANGED - Content was modified during observation"
    } else {
        print "âœ… SIZE CONSISTENT - No content changes detected"
    }
}