#!/usr/bin/env nu
# Cross-platform Wiki Link Management Service
# Manages startup, status, and control of the unified wiki-link-manager
# Replaced Python comprehensive_link_manager with native Nushell (2025-10-27)

def main [action?: string = "status"] {
    let link_manager_script = $"($env.HOME)/.local/bin/wiki-link-manager"
    let log_dir = $"($env.HOME)/scripts/wiki-link-manager/logs"

    # Ensure log directory exists
    mkdir $log_dir

    let pid_file = $"($log_dir)/linkmanager.pid"
    let log_file = $"($log_dir)/linkmanager.out.log"
    let err_file = $"($log_dir)/linkmanager.err.log"

    match $action {
        "start" => {
            if (link_service_running $pid_file) {
                print "âœ… Wiki link management service already running"
                return
            }

            print "ðŸš€ Starting unified wiki link management service..."
            print "   Script: wiki-link-manager (Nushell native)"
            print "   Features: Backlinks + Mark/Unmark unresolved"
            print ""

            # Start wiki-link-manager in background
            let start_command = $"($link_manager_script) > '($log_file)' 2> '($err_file)' & echo $!"

            # Start in background and capture PID
            let process = (bash -c $start_command)
            let pid = ($process | str trim)

            # Save PID to file
            $pid | save --force $pid_file

            print $"âœ… Wiki link management service started with PID ($pid)"
            print $"ðŸ“ Logs: ($log_file)"
            print $"âŒ Errors: ($err_file)"
        }

        "stop" => {
            if not (link_service_running $pid_file) {
                print "âš ï¸  Link management service not running"
                return
            }

            let pid = (open $pid_file | str trim)
            print $"ðŸ›‘ Stopping link management service with PID ($pid)..."

            try {
                kill $pid
                rm -f $pid_file
                print "âœ… Link management service stopped"
            } catch {
                print "âŒ Failed to stop service - may already be dead"
                rm -f $pid_file
            }
        }

        "restart" => {
            main "stop"
            sleep 2sec
            main "start"
        }

        "status" => {
            if (link_service_running $pid_file) {
                let pid = (open $pid_file | str trim)
                print $"âœ… Wiki link management service running with PID ($pid)"
                print "   Script: wiki-link-manager - unified Nushell system"

                # Show recent log activity
                if ($log_file | path exists) {
                    print "\nðŸ“ Recent activity:"
                    try {
                        open $log_file | lines | last 5 | each { |line| print $"   ($line)" }
                    } catch {
                        print "   (No recent activity)"
                    }
                }
            } else {
                print "âŒ Wiki link management service not running"
                print "ðŸ’¡ Run: link-service start"
            }
        }

        "logs" => {
            if ($log_file | path exists) {
                print "ðŸ“ Link management logs:"
                open $log_file | lines | last 20
            } else {
                print "âŒ No log file found"
            }
        }

        "errors" => {
            if ($err_file | path exists) {
                print "âŒ Link management errors:"
                open $err_file | lines | last 20
            } else {
                print "âœ… No error file found"
            }
        }

        _ => {
            print "Usage: link-service [start|stop|restart|status|logs|errors]"
            print ""
            print "Commands:"
            print "  start   - Start the link management service"
            print "  stop    - Stop the link management service"
            print "  restart - Restart the service"
            print "  status  - Show service status (default)"
            print "  logs    - Show recent service logs"
            print "  errors  - Show recent error logs"
        }
    }
}

def link_service_running [pid_file: path] {
    if not ($pid_file | path exists) {
        return false
    }

    let pid = (open $pid_file | str trim)

    # Check if process is actually running
    try {
        if ($nu.os-info.name == "macos") {
            let result = (^ps -p $pid | lines | length)
            $result > 1  # Header + process line
        } else {
            let result = (^ps -p $pid --no-headers | lines | length)
            $result > 0
        }
    } catch {
        false
    }
}