#!/bin/bash
# Setup complete Zellij zombie prevention system

echo "üõ†Ô∏è  Setting up Zellij Zombie Prevention System"
echo "=============================================="

# 1. Create log directory
mkdir -p ~/.local/share

# 2. Load the Launch Agent
echo "üì± Installing Launch Agent..."
launchctl unload ~/Library/LaunchAgents/com.williamnapier.zellij-zombie-watcher.plist 2>/dev/null || true
launchctl load ~/Library/LaunchAgents/com.williamnapier.zellij-zombie-watcher.plist

# 3. Add cron job for backup cleanup
echo "‚è∞ Setting up cron job..."
CRON_JOB="*/15 * * * * /opt/homebrew/bin/nu /Users/williamnapier/dotfiles/scripts/zellij-zombie-killer --auto >/dev/null 2>&1"

# Check if cron job already exists
if ! crontab -l 2>/dev/null | grep -q "zellij-zombie-killer"; then
    # Add to existing crontab
    (crontab -l 2>/dev/null; echo "$CRON_JOB") | crontab -
    echo "‚úÖ Cron job added: cleanup every 15 minutes"
else
    echo "‚ÑπÔ∏è  Cron job already exists"
fi

# 4. Test the system
echo ""
echo "üß™ Testing the system..."
ps aux | grep '[z]ellij' | wc -l | xargs echo "Current Zellij processes:"

# 5. Status check
echo ""
echo "üìä System Status:"
echo "- Launch Agent: $(launchctl list | grep zellij-zombie-watcher >/dev/null && echo "‚úÖ Running" || echo "‚ùå Not running")"
echo "- Cron Job: $(crontab -l 2>/dev/null | grep -q zellij-zombie-killer && echo "‚úÖ Installed" || echo "‚ùå Not installed")"
echo "- Watcher Script: $([ -x /Users/williamnapier/dotfiles/scripts/zellij-zombie-watcher ] && echo "‚úÖ Executable" || echo "‚ùå Not executable")"
echo "- Killer Script: $([ -f /Users/williamnapier/dotfiles/scripts/zellij-zombie-killer ] && echo "‚úÖ Present" || echo "‚ùå Missing")"

echo ""
echo "üéØ Prevention System Active!"
echo "- Event-based monitoring via Launch Agent"
echo "- Periodic cleanup every 15 minutes via cron"
echo "- Logs: ~/.local/share/zellij-zombie-*.log"
echo ""
echo "Manual commands:"
echo "- Check status: launchctl list | grep zellij"
echo "- View logs: tail -f ~/.local/share/zellij-zombie-watcher.log"
echo "- Manual cleanup: nu /Users/williamnapier/dotfiles/scripts/zellij-zombie-killer --auto"