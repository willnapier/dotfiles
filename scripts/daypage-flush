#!/usr/bin/env nu
# Merge ALL pending entries into their respective DayPages.
#
# Handles two kinds of queued instructions:
#   - Text lines (from daypage-append): inserted before ## Backlinks
#   - DONE:CLIENT_ID (from daypage-mark-done): toggles - [ ] → - [x]
#
# Helix keybinding chain (Space+U): :write! → :sh daypage-flush → :reload
# Exits silently if there's nothing to merge.

def main [] {
    let pending_dir = ($env.HOME | path join ".local" "share" "daypage-pending")
    let daypage_dir = ($env.HOME | path join "Forge" "NapierianLogs" "DayPages")

    # Exit silently if no pending directory
    if not ($pending_dir | path exists) { return }

    # Process all pending files (one per date)
    let pending_files = (ls $pending_dir | where name =~ '\.md$' | get name)
    if ($pending_files | is-empty) { return }

    for pending_file in $pending_files {
        let date = ($pending_file | path basename | str replace '.md' '')
        let daypage = ($daypage_dir | path join $"($date).md")

        # Skip if pending file is empty
        let content_raw = (open $pending_file --raw | str trim)
        if ($content_raw | is-empty) {
            rm $pending_file
            continue
        }

        # Skip if DayPage doesn't exist (can't flush to non-existent file)
        if not ($daypage | path exists) {
            print -e $"DayPage not found: ($daypage) — skipping"
            continue
        }

        let lines = ($content_raw | lines)
        let done_lines = ($lines | where {|l| $l | str starts-with "DONE:"})
        let append_lines = ($lines | where {|l| not ($l | str starts-with "DONE:")})

        mut content = (open $daypage --raw)

        # Process DONE markers: toggle checkboxes
        for line in $done_lines {
            let client_id = ($line | str replace "DONE:" "")
            $content = ($content | str replace $"- [ ] ($client_id)" $"- [x] ($client_id)")
        }

        # Process append lines: insert just above ## Backlinks (lowest available position)
        if not ($append_lines | is-empty) {
            let append_text = ($append_lines | str join "\n")
            $content = if ($content | str contains "## Backlinks") {
                $content | str replace "## Backlinks" $"($append_text)\n\n## Backlinks"
            } else {
                $"($content | str trim --right)\n\n($append_text)\n"
            }
        }

        $content | save -f $daypage
        rm $pending_file
    }
}
