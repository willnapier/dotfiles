#!/bin/bash
# Scan all notes for unchecked todos and create a dynamic todo view
# Keeps todos in context but provides a clean aggregated view

FORGE="${FORGE:-$HOME/Forge}"
TODO_CACHE="$HOME/.cache/active-todos.md"
TODO_JSON="$HOME/.cache/active-todos.json"

# Color codes for terminal output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Parse arguments
SHOW_CONTEXT=false
DAYS_BACK=30  # Default: show todos from last 30 days

while [[ $# -gt 0 ]]; do
    case $1 in
        --all) DAYS_BACK=9999 ;;
        --week) DAYS_BACK=7 ;;
        --context) SHOW_CONTEXT=true ;;
        --help)
            echo "Usage: todo-scanner [OPTIONS]"
            echo "Options:"
            echo "  --all      Show all todos (no time limit)"
            echo "  --week     Show todos from last 7 days only"
            echo "  --context  Show line after todo for context"
            echo "  --help     Show this help message"
            exit 0
            ;;
        *) echo "Unknown option: $1"; exit 1 ;;
    esac
    shift
done

# Function to calculate age of file
get_age_string() {
    local file=$1
    local modified=$(stat -f "%m" "$file" 2>/dev/null || stat -c "%Y" "$file" 2>/dev/null)
    local now=$(date +%s)
    local age_days=$(( (now - modified) / 86400 ))
    
    if [ $age_days -eq 0 ]; then
        echo "today"
    elif [ $age_days -eq 1 ]; then
        echo "yesterday"
    elif [ $age_days -lt 7 ]; then
        echo "${age_days}d ago"
    elif [ $age_days -lt 30 ]; then
        echo "$((age_days / 7))w ago"
    else
        echo "$((age_days / 30))mo ago"
    fi
}

# Header for the cache file
cat > "$TODO_CACHE" << 'EOF'
# Active TODOs
*Generated: DATE_PLACEHOLDER*
*Scope: SCOPE_PLACEHOLDER*

---

EOF

# Update placeholders
sed -i '' "s/DATE_PLACEHOLDER/$(date '+%Y-%m-%d %H:%M')/g" "$TODO_CACHE"
sed -i '' "s/SCOPE_PLACEHOLDER/Last $DAYS_BACK days/g" "$TODO_CACHE"

# Track stats
TOTAL=0

echo -e "${YELLOW}Scanning for unchecked todos...${NC}"

# Find all markdown files modified within DAYS_BACK days
# Using process substitution to avoid subshell variable loss
while read -r file; do
    # Skip the cache file itself
    [[ "$file" == "$TODO_CACHE" ]] && continue

    # Get relative path for display
    rel_path="${file#$FORGE/}"

    # Extract unchecked todos with line numbers
    while IFS=: read -r line_num todo; do
        # Clean up the todo text
        todo_text=$(echo "$todo" | sed 's/^[[:space:]]*- \[ \] //')

        # Get file age
        age=$(get_age_string "$file")

        # Determine category based on path
        category=$(echo "$rel_path" | cut -d'/' -f1)

        # Write to cache file
        echo "## $category / $(basename "$file" .md) *($age)*" >> "$TODO_CACHE"
        echo "- [ ] $todo_text" >> "$TODO_CACHE"
        echo "  *[[${rel_path%.md}#L$line_num]]*" >> "$TODO_CACHE"

        # Add context if requested
        if $SHOW_CONTEXT; then
            context=$(sed -n "$((line_num + 1))p" "$file" | sed 's/^/  > /')
            [ -n "$context" ] && echo "$context" >> "$TODO_CACHE"
        fi

        echo "" >> "$TODO_CACHE"

        TOTAL=$((TOTAL + 1))
    done < <(grep -n "^[[:space:]]*- \[ \]" "$file" 2>/dev/null)
done < <(find "$FORGE" -name "*.md" -type f -mtime -${DAYS_BACK}d)

# Add summary statistics
cat >> "$TODO_CACHE" << EOF

---

## Statistics
- **Total active todos**: $TOTAL
- **Scanned**: $(find "$FORGE" -name "*.md" -type f -mtime -${DAYS_BACK}d | wc -l | tr -d ' ') files
- **Time range**: Last $DAYS_BACK days
- **Last scan**: $(date '+%Y-%m-%d %H:%M')

EOF

# Create JSON version for Nushell processing
echo "[" > "$TODO_JSON"
first=true
while read -r file; do
    rel_path="${file#$FORGE/}"
    while IFS=: read -r line_num todo; do
        todo_text=$(echo "$todo" | sed 's/^[[:space:]]*- \[ \] //' | sed 's/"/\\"/g')
        modified=$(stat -f "%Y" "$file" 2>/dev/null || date -r "$file" '+%s' 2>/dev/null)

        if [ "$first" = false ]; then echo "," >> "$TODO_JSON"; fi
        first=false

        cat >> "$TODO_JSON" << EOJSON
  {
    "file": "$rel_path",
    "line": $line_num,
    "task": "$todo_text",
    "modified": $modified,
    "category": "$(echo "$rel_path" | cut -d'/' -f1)"
  }
EOJSON
    done < <(grep -n "^[[:space:]]*- \[ \]" "$file" 2>/dev/null)
done < <(find "$FORGE" -name "*.md" -type f -mtime -${DAYS_BACK}d)
echo -e "\n]" >> "$TODO_JSON"

# Summary output
echo -e "${GREEN}✓ Found $TOTAL active todos${NC}"
echo -e "${GREEN}✓ Saved to: $TODO_CACHE${NC}"
echo ""
echo "Quick commands:"
echo "  hx ~/.cache/active-todos.md    # View in Helix"
echo "  cat ~/.cache/active-todos.md   # Quick look"
echo ""

# If in Nushell, show a preview
if [ -n "$NU_VERSION" ]; then
    echo "For Nushell analysis:"
    echo "  open ~/.cache/active-todos.json | first 5"
fi