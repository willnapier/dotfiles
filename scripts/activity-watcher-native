#!/usr/bin/env nu

# Native Nushell Activity Duration Watcher
# Uses Nushell's built-in watch command - no external dependencies!
# This is the breakthrough solution using structured data principles

def main [] {
    print "ğŸš€ Starting native Nushell activity duration watcher..."
    print "ğŸ“ Using Nushell's built-in watch command with structured data"
    print "âš¡ No JSON parsing, no environment variables, just pure structured data!"
    print "ğŸ›‘ Press Ctrl+C to stop\n"
    
    let vault_path = $"($env.HOME)/Obsidian.nosync/Forge"
    
    print $"ğŸ“ Watching: ($vault_path)"
    print "ğŸ¯ Filtering: **/*.md files only"  
    print "â±ï¸  Debounce: 2000ms for batch changes"
    print "ğŸ”„ Ready for file changes...\n"
    
    # The breakthrough: Use Nushell's native watch with structured closure parameters
    watch $vault_path --glob "**/*.md" --debounce-ms 2000 {|operation, path, new_path|
        let timestamp = (date now | format date "%H:%M:%S")
        let filename = ($path | path basename)
        
        print $"[($timestamp)] ($operation) detected: ($filename)"
        
        # Only process actual file modifications, not directory events
        if ($operation == "Modify") and (($path | path parse).extension == "md") {
            print $"  ğŸ”„ Processing activity durations in ($filename)..."
            
            # Call our activity processor with the exact file path
            let result = (do { ^activity-duration-processor $path } | complete)
            
            if $result.exit_code == 0 {
                print $"  âœ… Successfully processed ($filename)"
            } else {
                print $"  âŒ Error processing ($filename): ($result.stderr)"
            }
        } else {
            print $"  â„¹ï¸  Skipping ($operation) event for ($filename)"
        }
        
        print ""  # Blank line for readability
    }
}