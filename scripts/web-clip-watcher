#!/bin/bash
# Auto-move SingleFile saves from Downloads to Captures
# Cross-platform: uses fswatch (macOS) or inotifywait (Linux)

SOURCE=~/Downloads
DEST=~/Captures/web-archives

mkdir -p "$DEST"

move_clips() {
    for f in "$SOURCE"/20[0-9][0-9]-[0-9][0-9]-[0-9][0-9]-*.html; do
        if [ -f "$f" ]; then
            filename=$(basename "$f")
            mv "$f" "$DEST/"
            echo "$(date '+%Y-%m-%d %H:%M:%S') Moved: $filename"
            if command -v notify-send &>/dev/null; then
                notify-send "Web Clip Saved" "$filename"
            elif command -v terminal-notifier &>/dev/null; then
                terminal-notifier -title "Web Clip Saved" -message "$filename" -sound default
            fi
        fi
    done
}

# Move any existing clips on startup
move_clips

echo "Watching $SOURCE for SingleFile saves..."

if command -v inotifywait &>/dev/null; then
    # Linux
    inotifywait -m -e create -e moved_to "$SOURCE" --format '%f' | while read -r filename; do
        if [[ "$filename" =~ ^20[0-9]{2}-[0-9]{2}-[0-9]{2}-.+\.html$ ]]; then
            sleep 1  # Let file finish writing
            move_clips
        fi
    done
elif command -v fswatch &>/dev/null; then
    # macOS
    fswatch -0 "$SOURCE" | while IFS= read -r -d '' event; do
        move_clips
    done
else
    echo "ERROR: Neither inotifywait nor fswatch found"
    exit 1
fi
