#!/bin/bash

# Project-aware file search for Yazi - CROSS-PLATFORM VERSION
# Uses working approach without skim terminal issues with preview support

set -euo pipefail

# Export shell for preview commands
export SHELL="/bin/bash"

# Get project root using the enhanced Nushell function (cross-platform)
PROJECT_ROOT=$(nu -c "source ~/.config/nushell/config.nu; find-project-root-enhanced | get path")

if [[ -z "$PROJECT_ROOT" ]]; then
    echo "Error: Could not detect project root" >&2
    exit 1
fi

# Safety check: Never search above home directory unless in a specific project
if [[ "$PROJECT_ROOT" == "/Users" ]] || [[ "$PROJECT_ROOT" == "/home" ]] || [[ "$PROJECT_ROOT" == "/" ]]; then
    echo "âš ï¸  Search scope too broad. Limiting to home directory" >&2
    PROJECT_ROOT="$HOME"
fi

echo "ðŸ” Searching in: $PROJECT_ROOT" >&2

# Use fd | sk pipeline and capture selection properly
cd "$PROJECT_ROOT"

# Terminal compatibility fixes for skim - following obsidian-linker pattern
export TERM="xterm"           # Use most basic, widely supported terminal type
unset TERMINFO                # Clear any conflicting terminfo
export COLORTERM=""           # Clear color term to avoid conflicts
export RUST_BACKTRACE=0       # Suppress Rust panic backtraces for cleaner output

# Ensure we have a proper terminal size
export LINES=$(tput lines 2>/dev/null || echo 24)
export COLUMNS=$(tput cols 2>/dev/null || echo 80)

echo "ðŸ” Running skim from: $(pwd)" >&2

# Run skim with preview and capture its exit status (cross-platform)
# Following working yazi-directory-jump terminal environment pattern
if selected=$(fd -t f -e md 2>/dev/null | \
    sk \
        --bind="tab:down" \
        --header="Project: $(basename "$PROJECT_ROOT")" \
        --preview="nu ~/.config/yazi/scripts/word-wrap-preview.nu {} 80" \
        --preview-window="right:60%"); then
    
    # Something was selected
    absolute_path="$PROJECT_ROOT/$selected"
    echo "ðŸ“ Opening: $selected" >&2
    exec hx "$absolute_path"
else
    # User cancelled or nothing selected
    echo "ðŸ“ Search cancelled" >&2
    exit 0
fi