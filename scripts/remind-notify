#!/bin/bash
# remind-notify — Notification daemon for DayPage reminders
# Runs every minute via launchd/systemd. Fires notifications for:
#   - Timed reminders: (at HH:MM) — when current time >= HH:MM
#   - Date-only reminders: no time marker — once on first run of the day
# Cross-platform: terminal-notifier (macOS), notify-send (Linux)

set -euo pipefail

REMINDERS_DIR="$HOME/Forge/NapierianLogs/Reminders"
STATE_DIR="$HOME/.local/share/remind-notified"
TODAY=$(date +%Y-%m-%d)
NOW_HHMM=$(date +%H:%M)
REMINDER_FILE="$REMINDERS_DIR/$TODAY.md"
STATE_FILE="$STATE_DIR/$TODAY.txt"

# Cross-platform notification function
notify() {
    local title="$1"
    local body="$2"
    if command -v terminal-notifier &>/dev/null; then
        terminal-notifier -title "$title" -message "$body" -sound Glass
    elif command -v notify-send &>/dev/null; then
        notify-send "$title" "$body" --urgency=normal
    else
        osascript -e "display alert \"$title\" message \"$body\"" 2>/dev/null || true
    fi
}

# Ensure state directory exists
mkdir -p "$STATE_DIR"

# Clean up old state files (keep last 7 days)
find "$STATE_DIR" -name "*.txt" -mtime +7 -delete 2>/dev/null || true

# Nothing to do if no reminder file for today
if [ ! -f "$REMINDER_FILE" ]; then
    exit 0
fi

# Create state file if missing
touch "$STATE_FILE"

# Read each unchecked reminder line
while IFS= read -r line; do
    # Skip checked items, headings, blank lines
    case "$line" in
        "- [x]"*|"- [X]"*|"#"*|"") continue ;;
        "- [ ]"*) ;;
        *) continue ;;
    esac

    # Extract the message (strip "- [ ] " prefix)
    msg="${line#- \[ \] }"

    # Check if already notified (match on full message)
    if grep -qFx "$msg" "$STATE_FILE" 2>/dev/null; then
        continue
    fi

    # Check for timed reminder: (at HH:MM)
    if echo "$msg" | grep -qE '\(at [0-9]{2}:[0-9]{2}\)'; then
        # Extract the time
        reminder_time=$(echo "$msg" | grep -oE '\(at [0-9]{2}:[0-9]{2}\)' | head -1 | tr -d '(at )')
        # Strip "(at HH:MM)" and "(from [[...]])" for display
        display_msg=$(echo "$msg" | sed -E 's/ *\(at [0-9]{2}:[0-9]{2}\)//' | sed -E 's/ *\(from \[\[.*\]\]\)//')

        # Fire only if current time >= reminder time
        if [ "$NOW_HHMM" \< "$reminder_time" ]; then
            continue
        fi

        notify "Reminder ($reminder_time)" "$display_msg"
        echo "$msg" >> "$STATE_FILE"
    else
        # Date-only reminder — fire once (first run of the day)
        # Strip "(from [[...]])" for display
        display_msg=$(echo "$msg" | sed -E 's/ *\(from \[\[.*\]\]\)//')

        notify "Reminder" "$display_msg"
        echo "$msg" >> "$STATE_FILE"
    fi
done < <(cat "$REMINDER_FILE"; echo)
