#!/usr/bin/env bash

# Syncthing Sync Watchdog
# Detects when file sync between Mac and Nimbini has stalled
#
# How it works:
# 1. Writes current timestamp to a heartbeat file in Forge
# 2. Checks if Nimbini's copy of a previous heartbeat is recent
# 3. Alerts if sync appears stalled (Nimbini copy > 10 mins behind)
#
# Run via launchd every 5 minutes

set -euo pipefail

HEARTBEAT_FILE="$HOME/Forge/.syncthing-heartbeat-mac"
STALE_THRESHOLD_SECONDS=600  # 10 minutes
LOG_FILE="$HOME/Library/Logs/syncthing-watchdog.log"
NIMBINI_HOST="will@nimbini"

log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') $1" >> "$LOG_FILE"
}

alert() {
    local msg="$1"
    log "ALERT: $msg"
    # macOS notification
    osascript -e "display notification \"$msg\" with title \"Syncthing Watchdog\" sound name \"Basso\"" 2>/dev/null || true
    # Also write to a status file for easy checking
    echo "STALLED: $msg ($(date))" > "$HOME/.syncthing-watchdog-status"
}

clear_alert() {
    echo "OK: Last check $(date)" > "$HOME/.syncthing-watchdog-status"
}

# Write current heartbeat
write_heartbeat() {
    local now
    now=$(date +%s)
    echo "$now" > "$HEARTBEAT_FILE"
    log "Wrote heartbeat: $now"
}

# Check if Nimbini received recent heartbeat
check_nimbini_heartbeat() {
    local remote_file="/home/will/Forge/.syncthing-heartbeat-mac"
    local remote_timestamp
    local now
    local age

    # Get timestamp from Nimbini (with timeout)
    if ! remote_timestamp=$(ssh -o ConnectTimeout=10 "$NIMBINI_HOST" "cat $remote_file" 2>/dev/null); then
        log "Could not read heartbeat from Nimbini (SSH failed or file missing)"
        # Don't alert on first run or if Nimbini is offline
        return 0
    fi

    # Validate it's a number
    if ! [[ "$remote_timestamp" =~ ^[0-9]+$ ]]; then
        log "Invalid timestamp from Nimbini: $remote_timestamp"
        return 0
    fi

    now=$(date +%s)
    age=$((now - remote_timestamp))

    log "Nimbini heartbeat age: ${age}s (threshold: ${STALE_THRESHOLD_SECONDS}s)"

    if [ "$age" -gt "$STALE_THRESHOLD_SECONDS" ]; then
        alert "Sync stalled! Nimbini heartbeat is ${age}s old (threshold: ${STALE_THRESHOLD_SECONDS}s)"
        return 1
    else
        clear_alert
        return 0
    fi
}

main() {
    mkdir -p "$(dirname "$LOG_FILE")"

    case "${1:-run}" in
        run)
            write_heartbeat
            check_nimbini_heartbeat
            ;;
        status)
            if [ -f "$HOME/.syncthing-watchdog-status" ]; then
                cat "$HOME/.syncthing-watchdog-status"
            else
                echo "No status yet (watchdog hasn't run)"
            fi
            ;;
        logs)
            tail -50 "$LOG_FILE" 2>/dev/null || echo "No logs yet"
            ;;
        test)
            echo "Testing watchdog..."
            write_heartbeat
            echo "Heartbeat written. Checking Nimbini..."
            check_nimbini_heartbeat && echo "OK: Sync is healthy" || echo "ALERT: Sync appears stalled"
            ;;
        *)
            echo "Syncthing Sync Watchdog"
            echo ""
            echo "Usage: syncthing-sync-watchdog [command]"
            echo ""
            echo "Commands:"
            echo "  run     - Write heartbeat and check sync (default)"
            echo "  status  - Show current watchdog status"
            echo "  logs    - Show recent watchdog logs"
            echo "  test    - Run once with verbose output"
            ;;
    esac
}

main "$@"
