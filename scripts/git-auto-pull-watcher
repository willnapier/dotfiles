#!/usr/bin/env nu

# Git Auto-Pull Watcher - Automatically pulls git changes for seamless syncing
# Checks for remote changes every 2 minutes and pulls automatically
# Handles both ~/dotfiles (with dotter deploy) and ~/Assistants

def pull-repo [repo_dir: string, label: string, log_file: string, deploy: bool] {
    try {
        cd $repo_dir

        # Fetch remote changes
        let fetch_result = (do { git fetch origin } | complete)

        if $fetch_result.exit_code == 0 {
            let behind_result = (do { git rev-list HEAD..origin/main --count } | complete)

            if $behind_result.exit_code == 0 and ($behind_result.stdout | str trim | into int) > 0 {
                let timestamp = (date now | format date "%Y-%m-%d %H:%M:%S")
                let commits_behind = ($behind_result.stdout | str trim)

                print $"ğŸ“¥ [($label)] Remote changes detected: ($commits_behind) commits behind"
                $"[($timestamp)] ğŸ“¥ [($label)] Remote changes detected: ($commits_behind) commits behind" | save --append $log_file

                # Pull the changes
                let pull_result = (do { git pull origin main } | complete)

                if $pull_result.exit_code == 0 {
                    print $"âœ… [($label)] Successfully pulled changes"
                    $"[($timestamp)] âœ… [($label)] Successfully pulled changes" | save --append $log_file

                    # Run dotter deploy if this is dotfiles
                    if $deploy {
                        let deploy_result = (do { dotter deploy } | complete)

                        if $deploy_result.exit_code == 0 {
                            print $"âœ… [($label)] Dotter deploy successful - configs updated"
                            $"[($timestamp)] âœ… [($label)] Dotter deploy successful - configs updated" | save --append $log_file
                        } else {
                            print $"âŒ [($label)] Dotter deploy failed: ($deploy_result.stderr)"
                            $"[($timestamp)] âŒ [($label)] Dotter deploy failed: ($deploy_result.stderr)" | save --append $log_file
                        }
                    }
                } else {
                    print $"âŒ [($label)] Git pull failed: ($pull_result.stderr)"
                    $"[($timestamp)] âŒ [($label)] Git pull failed: ($pull_result.stderr)" | save --append $log_file
                }
            }
        } else {
            let timestamp = (date now | format date "%Y-%m-%d %H:%M:%S")
            print $"âŒ [($label)] Git fetch failed: ($fetch_result.stderr)"
            $"[($timestamp)] âŒ [($label)] Git fetch failed: ($fetch_result.stderr)" | save --append $log_file
        }
    } catch {|error|
        let timestamp = (date now | format date "%Y-%m-%d %H:%M:%S")
        print $"âŒ [($label)] Error: ($error.msg)"
        $"[($timestamp)] âŒ [($label)] Error: ($error.msg)" | save --append $log_file
    }
}

def main [] {
    let dotfiles_dir = $"($env.HOME)/dotfiles"
    let assistants_dir = $"($env.HOME)/Assistants"
    let log_file = $"($env.HOME)/.local/share/git-auto-pull-watcher.log"
    let lock_file = "/tmp/git-auto-pull-watcher.lock"

    # Ensure log directory exists
    mkdir ($log_file | path dirname)

    # Smart lock file handling with stale lock detection
    if ($lock_file | path exists) {
        let lock_age = ((date now) - (ls $lock_file | get 0.modified))
        let age_minutes = ($lock_age / 1min)

        if $age_minutes > 10 {
            let timestamp = (date now | format date "%Y-%m-%d %H:%M:%S")
            let cleanup_msg = $"[($timestamp)] Cleaning up stale lock file"
            $cleanup_msg | save --append $log_file
            print $cleanup_msg
            rm -f $lock_file
        } else {
            print "âŒ Git auto-pull watcher already running (recent lock file)"
            exit 1
        }
    }

    # Create lock file
    "running" | save --force $lock_file

    print "ğŸš€ Starting Git auto-pull watcher"
    print $"ğŸ“ Monitoring: ($dotfiles_dir), ($assistants_dir)"
    print $"ğŸ“ Logging to: ($log_file)"

    # Initial log entry
    let timestamp = (date now | format date "%Y-%m-%d %H:%M:%S")
    $"[($timestamp)] ğŸš€ Git auto-pull watcher started (dotfiles + Assistants)" | save --append $log_file

    # Main loop - check every 2 minutes
    loop {
        sleep 2min

        pull-repo $dotfiles_dir "dotfiles" $log_file true
        pull-repo $assistants_dir "Assistants" $log_file false
    }

    # Cleanup on exit
    rm -f $lock_file
    print "ğŸ›‘ Git auto-pull watcher stopped"
}
