#!/usr/bin/env bash
# setup-realtime-onboarding - Deploy event-driven config onboarding
# Replaces inefficient cron polling with smart event-driven monitoring
# Cross-platform: macOS (LaunchAgent) and Linux (systemd)

set -euo pipefail

SCRIPT_NAME="dotter-realtime-watcher"
DOTFILES_ROOT="$HOME/dotfiles"

# Platform-specific configuration
case "$(uname -s)" in
    Darwin)
        PLATFORM="macos"
        SERVICE_NAME="com.user.dotter-realtime-watcher.plist"
        SERVICE_SOURCE="$DOTFILES_ROOT/launchagents/$SERVICE_NAME"
        SERVICE_TARGET="$HOME/Library/LaunchAgents/$SERVICE_NAME"
        ;;
    Linux)
        PLATFORM="linux"
        SERVICE_NAME="dotter-realtime-watcher.service"
        SERVICE_SOURCE="$DOTFILES_ROOT/systemd/$SERVICE_NAME"
        SERVICE_TARGET="$HOME/.config/systemd/user/$SERVICE_NAME"
        ;;
    *)
        echo "âŒ Unsupported platform: $(uname -s)"
        exit 1
        ;;
esac

usage() {
    echo "ğŸš€ Real-Time Config Onboarding Setup"
    echo "===================================="
    echo ""
    echo "Usage: $0 [OPTION]"
    echo ""
    echo "Options:"
    echo "  --enable     Start event-driven onboarding (recommended)"
    echo "  --disable    Stop real-time monitoring"
    echo "  --status     Check if service is running"
    echo "  --logs       Show recent activity logs"
    echo ""
    echo "Benefits of real-time vs cron:"
    echo "  âš¡ Immediate response to config changes"
    echo "  ğŸ”‹ Much lower CPU usage (event-driven vs polling)"
    echo "  ğŸ›¡ï¸  Zero drift - configs onboarded instantly"
    echo "  ğŸ“Š ~99% reduction in unnecessary processing"
}

enable_realtime() {
    echo "ğŸš€ Setting up real-time config onboarding..."
    
    # 1. Ensure script is executable
    chmod +x "$DOTFILES_ROOT/scripts/$SCRIPT_NAME"
    
    # 2. Deploy with Dotter if needed
    if ! command -v "$SCRIPT_NAME" >/dev/null 2>&1; then
        echo "ğŸ“¦ Deploying script via Dotter..."
        cd "$DOTFILES_ROOT"
        dotter deploy
    fi
    
    # 3. Set up platform-specific service
    if [[ "$PLATFORM" == "macos" ]]; then
        setup_macos_service
    else
        setup_linux_service
    fi
}

setup_macos_service() {
    echo "ğŸ Setting up macOS LaunchAgent..."
    
    if [[ -f "$SERVICE_SOURCE" ]]; then
        cp "$SERVICE_SOURCE" "$SERVICE_TARGET"
        echo "âœ… LaunchAgent installed: $SERVICE_TARGET"
    else
        echo "âŒ LaunchAgent source not found: $SERVICE_SOURCE"
        exit 1
    fi
    
    # Load the service
    echo "â–¶ï¸  Loading real-time watcher service..."
    if launchctl load "$SERVICE_TARGET" 2>/dev/null; then
        echo "âœ… Service loaded successfully"
    else
        echo "âš ï¸  Service may already be loaded (this is OK)"
    fi
    
    # Verify it's running
    sleep 2
    if launchctl list | rg -q "dotter-realtime-watcher"; then
        echo "ğŸ‰ Real-time onboarding is now ACTIVE!"
        show_success_message
    else
        echo "âŒ Service may not be running properly"
        echo "ğŸ’¡ Check logs: $0 --logs"
    fi
}

setup_linux_service() {
    echo "ğŸ§ Setting up Linux systemd user service..."
    
    # Create systemd user directory if needed
    mkdir -p "$(dirname "$SERVICE_TARGET")"
    
    if [[ -f "$SERVICE_SOURCE" ]]; then
        cp "$SERVICE_SOURCE" "$SERVICE_TARGET"
        echo "âœ… systemd service installed: $SERVICE_TARGET"
    else
        echo "âŒ systemd service source not found: $SERVICE_SOURCE"
        exit 1
    fi
    
    # Reload systemd and enable service
    echo "â–¶ï¸  Enabling and starting systemd service..."
    systemctl --user daemon-reload
    systemctl --user enable dotter-realtime-watcher.service
    systemctl --user start dotter-realtime-watcher.service
    
    # Verify it's running
    sleep 2
    if systemctl --user is-active dotter-realtime-watcher.service >/dev/null; then
        echo "ğŸ‰ Real-time onboarding is now ACTIVE!"
        show_success_message
    else
        echo "âŒ Service may not be running properly"
        echo "ğŸ’¡ Check logs: $0 --logs"
    fi
}

show_success_message() {
    echo ""
    echo "ğŸ“Š System will now:"
    echo "   â€¢ Monitor config changes in real-time"
    echo "   â€¢ Instantly onboard new configs"
    echo "   â€¢ Use minimal CPU (event-driven)"
    echo "   â€¢ Send notifications for onboarded files"
    echo ""
    echo "ğŸ“ Logs: ~/.local/share/dotter-realtime-watcher.log"
}

disable_realtime() {
    echo "â¹ï¸  Disabling real-time onboarding..."
    
    if [[ "$PLATFORM" == "macos" ]]; then
        disable_macos_service
    else
        disable_linux_service
    fi
    
    echo "ğŸ“´ Real-time onboarding disabled"
    echo "ğŸ’¡ Configs will no longer be auto-onboarded"
}

disable_macos_service() {
    if launchctl list | rg -q "dotter-realtime-watcher"; then
        launchctl unload "$SERVICE_TARGET" 2>/dev/null || true
        echo "âœ… LaunchAgent service stopped"
    fi
    
    if [[ -f "$SERVICE_TARGET" ]]; then
        rm "$SERVICE_TARGET"
        echo "âœ… LaunchAgent removed"
    fi
}

disable_linux_service() {
    if systemctl --user is-active dotter-realtime-watcher.service >/dev/null 2>&1; then
        systemctl --user stop dotter-realtime-watcher.service
        echo "âœ… systemd service stopped"
    fi
    
    if systemctl --user is-enabled dotter-realtime-watcher.service >/dev/null 2>&1; then
        systemctl --user disable dotter-realtime-watcher.service
        echo "âœ… systemd service disabled"
    fi
    
    if [[ -f "$SERVICE_TARGET" ]]; then
        rm "$SERVICE_TARGET"
        systemctl --user daemon-reload
        echo "âœ… systemd service file removed"
    fi
}

check_status() {
    echo "ğŸ“Š Real-Time Onboarding Status ($PLATFORM)"
    echo "=============================="
    
    if [[ -f "$SERVICE_TARGET" ]]; then
        echo "âœ… Service configuration installed"
        
        if [[ "$PLATFORM" == "macos" ]]; then
            check_macos_status
        else
            check_linux_status
        fi
        
        # Check recent activity
        local log_file="$HOME/.local/share/dotter-realtime-watcher.log"
        if [[ -f "$log_file" ]]; then
            echo ""
            echo "ğŸ“‹ Recent activity (last 5 lines):"
            tail -5 "$log_file"
        fi
    else
        echo "âŒ Not installed"
        echo "ğŸ’¡ Run: $0 --enable"
    fi
}

check_macos_status() {
    if launchctl list | rg -q "dotter-realtime-watcher"; then
        echo "âœ… LaunchAgent service is running"
    else
        echo "âŒ LaunchAgent service is not running"
        echo "ğŸ’¡ Run: $0 --enable"
    fi
}

check_linux_status() {
    if systemctl --user is-active dotter-realtime-watcher.service >/dev/null 2>&1; then
        echo "âœ… systemd service is running"
        
        if systemctl --user is-enabled dotter-realtime-watcher.service >/dev/null 2>&1; then
            echo "âœ… systemd service is enabled (starts on boot)"
        else
            echo "âš ï¸  systemd service is running but not enabled"
        fi
    else
        echo "âŒ systemd service is not running"
        
        if systemctl --user is-enabled dotter-realtime-watcher.service >/dev/null 2>&1; then
            echo "âš ï¸  systemd service is enabled but not running"
        fi
        
        echo "ğŸ’¡ Run: $0 --enable"
    fi
}

show_logs() {
    local log_file="$HOME/.local/share/dotter-realtime-watcher.log"
    
    if [[ -f "$log_file" ]]; then
        echo "ğŸ“‹ Real-Time Onboarding Activity Log"
        echo "===================================="
        echo ""
        tail -20 "$log_file"
    else
        echo "ğŸ“­ No logs found yet"
        echo "ğŸ’¡ Service may not be running: $0 --status"
    fi
}

# Main execution
case "${1:-}" in
    --enable)
        enable_realtime
        ;;
    --disable)
        disable_realtime
        ;;
    --status)
        check_status
        ;;
    --logs)
        show_logs
        ;;
    *)
        usage
        ;;
esac