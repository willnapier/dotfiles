#!/bin/bash

# Smart Zellij launcher with screen-aware layout selection and session management
# Usage: zj [additional-zellij-args]
#
# Known displays:
# - 32" Dell 6K: 6016 x 3384 (home)
# - 27" Apple Thunderbolt: 2560 x 1440 (flat)  
# - 15" MacBook Air: 2880 x 1864 (mobile)

# Get screen resolution to determine which layout to use
# Get both width and height to differentiate between displays with same width
if [[ "$OSTYPE" == "darwin"* ]]; then
    # macOS
    RESOLUTION=$(system_profiler SPDisplaysDataType | grep Resolution | head -1 | sed 's/.*Resolution: //')
    SCREEN_WIDTH=$(echo $RESOLUTION | awk '{print $1}')
    SCREEN_HEIGHT=$(echo $RESOLUTION | awk '{print $3}')
else
    # Linux - use xrandr
    if command -v xrandr >/dev/null 2>&1; then
        RESOLUTION=$(xrandr | grep ' connected primary\| connected [0-9]' | head -1 | grep -o '[0-9]\+x[0-9]\+')
        SCREEN_WIDTH=$(echo $RESOLUTION | cut -d'x' -f1)
        SCREEN_HEIGHT=$(echo $RESOLUTION | cut -d'x' -f2)
    else
        # Fallback to a reasonable default if xrandr not available
        echo "⚠️  Cannot detect screen resolution - defaulting to laptop layout"
        SCREEN_WIDTH=1920
        SCREEN_HEIGHT=1080
    fi
fi

# Determine layout and session suffix based on screen dimensions
if [[ "$SCREEN_WIDTH" -ge 6000 ]]; then
    # 32" Dell 6K - your main monitor at home
    LAYOUT="desktop-quarters"
    SESSION_SUFFIX="6k"
    echo "🏠 Detected 32\" Dell 6K ($RESOLUTION) - using desktop-quarters layout (4 equal quarters)"
elif [[ "$SCREEN_WIDTH" == "2880" ]] && [[ "$SCREEN_HEIGHT" == "1864" ]]; then
    # 15" MacBook Air - has 2880x1864 resolution
    LAYOUT="laptop" 
    SESSION_SUFFIX="laptop"
    echo "💻 Detected MacBook Air 15\" ($RESOLUTION) - using laptop layout (2-tab)"
elif [[ "$SCREEN_WIDTH" -ge 2560 ]]; then
    # 27" Thunderbolt display or similar external monitor
    LAYOUT="desktop-27"
    SESSION_SUFFIX="27"
    echo "📺 Detected 27\" display ($RESOLUTION) - using desktop-27 layout (3-pane)"
else
    LAYOUT="laptop"
    SESSION_SUFFIX="laptop"
    echo "🔍 Unknown display size ($RESOLUTION) - defaulting to laptop layout"
fi

# Create screen-specific session name
SESSION_NAME="main-${SESSION_SUFFIX}"

# Check if we're already inside a Zellij session
if [[ -n "$ZELLIJ" ]]; then
    echo "⚠️  Already inside a Zellij session. Use 'exit' first to switch sessions."
    exit 1
fi

# Cleanup workaround for known Zellij zombie session bugs
# See: https://github.com/zellij-org/zellij/issues/3918
echo "🧹 Working around Zellij zombie session bugs..."
for session in $(zellij list-sessions --no-formatting 2>/dev/null | grep "EXITED" | awk '{print $1}'); do
    zellij delete-session "$session" 2>/dev/null || true
done

# Check if a session for this screen size already exists
if zellij list-sessions --no-formatting 2>/dev/null | grep -q "$SESSION_NAME"; then
    echo "🔄 Attaching to existing $SESSION_SUFFIX session: $SESSION_NAME"
    exec zellij attach "$SESSION_NAME" "$@"
else
    echo "🆕 Creating new $SESSION_SUFFIX session: $SESSION_NAME"
    # Start fresh session with layout
    exec zellij --layout "$LAYOUT" "$@"
fi