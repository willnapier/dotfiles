#!/bin/bash
# Auto-detect system appearance and set Helix theme accordingly

# Resolve symlink to get actual file location
CONFIG_FILE="$(readlink -f "$HOME/.config/helix/config.toml" 2>/dev/null || realpath "$HOME/.config/helix/config.toml" 2>/dev/null || echo "$HOME/.config/helix/config.toml")"

# If still a symlink or doesn't exist, use the dotfiles location directly
if [ ! -f "$CONFIG_FILE" ] || [ -L "$CONFIG_FILE" ]; then
    CONFIG_FILE="$HOME/dotfiles/helix/config.toml"
fi

# Get system theme using cross-platform detection
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
THEME=$("$SCRIPT_DIR/get-system-theme.sh")

if [[ "$THEME" == "dark" ]]; then
    # Dark mode detected
    sd 'theme = "solarized_light_modal"' 'theme = "solarized_dark_modal"' "$CONFIG_FILE"
    sd 'theme = "solarized_light"' 'theme = "solarized_dark"' "$CONFIG_FILE"
    # Debug output
    >&2 echo "hx-auto: Set dark theme"
else
    # Light mode
    sd 'theme = "solarized_dark_modal"' 'theme = "solarized_light_modal"' "$CONFIG_FILE"
    sd 'theme = "solarized_dark"' 'theme = "solarized_light"' "$CONFIG_FILE"
    # Debug output
    >&2 echo "hx-auto: Set light theme"
fi

# Launch Helix with all arguments (cross-platform)
# Look for the actual Helix binary, not our wrapper scripts
# Check specific locations first to avoid finding our wrapper script
if [[ -x "/opt/homebrew/bin/hx" ]]; then
    # macOS with Homebrew
    exec /opt/homebrew/bin/hx "$@"
elif [[ -x "/usr/bin/helix" ]]; then
    # Linux standard location
    exec /usr/bin/helix "$@"
elif [[ -x "/usr/local/bin/helix" ]]; then
    # Linux alternative location
    exec /usr/local/bin/helix "$@"
elif [[ -x "$HOME/.cargo/bin/helix" ]]; then
    # Rust cargo installation
    exec "$HOME/.cargo/bin/helix" "$@"
elif [[ -x "/usr/bin/hx" ]]; then
    # Alternative Linux location
    exec /usr/bin/hx "$@"
else
    # Last resort: try to find helix (not hx to avoid recursion)
    if command -v helix &> /dev/null; then
        exec helix "$@"
    else
        echo "Error: Helix binary not found in standard locations" >&2
        echo "Checked: /opt/homebrew/bin/hx, /usr/bin/helix, /usr/local/bin/helix, ~/.cargo/bin/helix" >&2
        exit 1
    fi
fi