# ⚠️  CLAUDE CODE: THIS FILE IS DOTTER-MANAGED - EDIT HERE IN DOTFILES, NOT ~/.config/helix/
# ⚠️  NEVER EDIT ~/.config/helix/config.toml - IT'S A SYMLINK TO THIS FILE
# Helix Configuration for Colemak-DH - LINUX OVERRIDE
# This file overrides config.toml on Linux only (see .dotter/global.toml)
# Sync test: $(date)

# Use standard Solarized themes - change based on system appearance
# For dark mode: theme = "solarized_dark" 
# For light mode: theme = "solarized_dark"
# Modal versions with mode indicators: "solarized_dark_modal" or "solarized_light_modal"
theme = "solarized_dark_modal"

[editor]
# Enable cursor shape changing
cursorline = true
# Idle timeout for various features (affects multiple systems)
idle-timeout = 500
# Linux/Niri: Reduce scroll speed (touchpad scrolls too fast in Helix vs other apps)
scroll-lines = 1

# Enhanced auto-save configuration
[editor.auto-save]
focus-lost = true           # Save when Helix loses focus (prevents data loss)

[editor.auto-save.after-delay]
enable = true               # Save after idle period
timeout = 500               # Save after 500ms inactivity (for activity duration processing)

# Persistent undo - not available in Helix 25.07.1
# [editor.undo]
# save = true

# Status line configuration
[editor.statusline]
left = ["mode", "spinner", "file-name", "file-modification-indicator"]
center = []
right = ["diagnostics", "selections", "position", "position-percentage", "file-encoding", "file-type"]

# Soft wrap configuration
[editor.soft-wrap]
enable = true
max-wrap = 25  # increase value to reduce forced mid-word wrapping
max-indent-retain = 0
wrap-indicator = ""  # set to "" to hide wrap indicator

[editor.cursor-shape]
insert = "bar"
normal = "block"
select = "underline"

[keys.normal]
# Navigation (neio for hjkl)
n = "move_char_left"
e = "move_line_down"
i = "move_line_up"
o = "move_char_right"

# Fix for ZMK keyboard key interpretation in WezTerm
# These explicit bindings ensure correct behavior regardless of terminal interpretation
# ZMK sends US layout keycodes, macOS expects British layout, causing symbol misinterpretation
# This is a stable solution - no need to modify ZMK firmware (2025-09-09)
"$" = "goto_line_end"              # End of line
"0" = "goto_line_start"            # Beginning of line  
"^" = "goto_first_nonwhitespace"   # First non-whitespace
"%" = "match_brackets"              # Match bracket
"_" = "goto_first_nonwhitespace"   # Also first non-whitespace (alternate)
"|" = "goto_column"                 # Go to column
"*" = "search_selection"            # Search for selection
"#" = "search_prev"                 # Search backwards
"&" = "shell_keep_pipe"             # Ensure & works correctly for its intended purpose

# Displaced commands
h = "open_below"           # was on 'o'
j = "search_next"          # was on 'n'
k = "move_next_word_end"   # was on 'e'
l = "find_till_char"       # was on 't' (tilL)
t = "insert_mode"          # was on 'i' (inserT)

# Shifted versions for consistency
N = "extend_char_left"     # extend version of 'n'
E = "extend_line_down"     # extend version of 'e'
I = "extend_line_up"       # extend version of 'i'
O = "extend_char_right"    # extend version of 'o'
H = "open_above"           # pair with 'h' (open_below)
J = "search_prev"          # pair with 'j' (search_next)
K = "extend_next_word_end" # extend version of 'k'
L = "till_prev_char"       # pair with 'l' (till forward)
T = "insert_at_line_start"  # was on 'I' (Insert at line start)

[keys.normal.space]
# Toggle todo checkbox - Space+t (3-state: no checkbox → unchecked → checked → unchecked)
t = ["extend_to_line_bounds", ":pipe hx-toggle-todo"]

# Manual theme refresh - Space+T (capital T)  
T = ":config-reload"
# Process activity durations - WezTerm auto-refresh (fully automated)
p = [":write!", ":sh sleep 1 && sync", ":sh hx-process-durations-wezterm %{buffer_name}"]
# Delete current file - Space+x (eXpunge, no confirmation)
x = [":sh trash '%{buffer_name}'", ":quit!"]
# Export selection to external register - Space+E (then type register letter)
E = ":pipe-to hx-register-export"
# Wiki link navigation - Space+w (smart opening: text in popup, media in Preview)
# Text files (.md) open in floating Helix popup (close with Ctrl+q)
# Media files (images, PDFs) open in system viewer (Preview/xdg-open)
w = [":sh echo %{buffer_name} > /tmp/helix-current-file.txt", ":sh echo %{buffer_name} >> /tmp/wiki-nav-history.txt", "extend_to_line_bounds", ":pipe-to ~/.local/bin/hx-wiki.nu", ":sh sleep 0.1 && hx-wiki-open-smart"]
# Web clip - Space+C: move latest SingleFile save and insert wikilink
C = ":insert-output hx-web-clip"
# Web archive link - Space+A: browse existing archives and insert wikilink
A = ":insert-output hx-web-link"
# Concert capture - Space+D: process latest Wigmore HTML, append to DayPage, reload
D = ":insert-output hx-concert-capture"
# Wiki link navigation to NEW PANE RIGHT - Space+W (Zellij-only, for recursive exploration)
# Creates new pane and runs hx-wiki-open-right script there
W = [":sh echo %{buffer_name} > /tmp/helix-current-file.txt", ":sh echo %{buffer_name} >> /tmp/wiki-nav-history.txt", ":write", "extend_to_line_bounds", ":pipe-to ~/.local/bin/hx-wiki.nu", ":sh sleep 0.1", ":sh zellij run --direction right --close-on-exit -- hx-wiki-open-right"]
# Wiki link navigation to NEW TAB - Space+n (Zellij-only)
# Creates new tab with the linked file ("n" for new tab)
n = [":sh echo %{buffer_name} > /tmp/helix-current-file.txt", ":sh echo %{buffer_name} >> /tmp/wiki-nav-history.txt", ":write", "extend_to_line_bounds", ":pipe-to ~/.local/bin/hx-wiki.nu", ":sh sleep 0.1", ":sh zellij action new-tab && sleep 0.2 && zellij action write-chars 'hx /tmp/helix-current-link.md' && zellij action write 10"]
# Smart file opener - Space+o (handles all file types and wiki links)
o = ["extend_to_line_bounds", ":pipe-to hx-open-system-rust"]  # Open in system app (Preview, Excel, etc.)
# Fuzzy link insertion - Space+l (Zellij floating pane)
# Note: Use Alt+l in Zellij for floating pane link picker
# Then paste result with standard paste command
l = ":insert-output hx-clipboard-paste"
# Show real file name - Space+i (Info about current file)
i = ":sh hx-show-real-file %{buffer_name}"
# Quick save commands - Space+m ("memorize" or "save to memory")
m = ":write"         # Quick save current file
M = ":write-all"     # Save all modified files
# Flush pending DayPage entries - Space+U (Update from queue)
# Claude skills queue entries via daypage-append; this merges them in
U = [":write!", ":sh daypage-flush-wezterm"]

# Clipboard yank - Space+y (cross-platform, works in Zellij/WezTerm)
y = ":pipe-to hx-clipboard-copy"

# Date and time insertion - Space+c ("calendar" or "chronos")
# Moved from Space+d to avoid conflict with diagnostic picker (important for Rust LSP)
c = ":insert-output hx-insert-date"        # Insert current date (YYYY-MM-DD)
# Time insertion moved to avoid conflicts with Space+t (todo toggle) and Space+T (config reload)
";" = ":insert-output hx-insert-datetime"  # Insert date and time (YYYY-MM-DD HH:MM)
":" = [":insert-output hx-insert-time", "goto_line_end"]  # Insert current time (HH:MM), cursor to end
# Mark file as revisited - using 'v' for 'visited'
v = ":sh hx-mark-revisit %{buffer_name}"   # Add today to revisited dates

# Removed: Space+. export (wiki-nav now auto-detects most recent file)

# Buffer navigation - Space+b for back (intuitive)
b = [":write-all", "goto_previous_buffer", ":sh sleep 0.5", ":reload-all"]  # Save all, go back, wait for backlinks, reload all

# Save and return to previous buffer - Space+q
q = [":write", ":buffer-previous"]       # Save then go to previous buffer
Q = ":quit!"                                # Force quit without saving

# Day navigation moved to g[ and g] (Space+[ crashes Helix — [ is a prefix key)

# Custom g-prefix commands
[keys.normal.g]
R = ":reload-all"  # Reload all buffers (refresh external changes)
"[" = ":sh hx-day-nav prev %{buffer_name}"    # Previous day's note
"]" = ":sh hx-day-nav next %{buffer_name}"    # Next day's note
f = ["extend_to_line_bounds", ":pipe-to hx-smart-gf-rust", ":open /tmp/helix-gf-target.md"]  # Smart file opener (Rust/Nushell version with fd, rg)
x = ["extend_to_line_bounds", ":pipe-to hx-open-url"]  # Open URLs
w = ["extend_to_line_bounds", ":pipe-to hx-wiki.nu", ":sh sleep 0.1 && hx-wiki-open-smart"]  # Wiki link navigation (smart: text in popup, media in viewer)

# Serpl search and replace integration - Space+r,r
[keys.normal.space.r]
r = [
  ":write-all",
  ":sh git add -A && git commit -m 'pre-serpl snapshot' || true",
  ":insert-output nu -c 'serpl-anywhere >/dev/tty'",
  ":redraw",
  ":reload-all"
]

[keys.select]
# Same navigation in select mode
n = "extend_char_left"
e = "extend_line_down"
i = "extend_line_up"
o = "extend_char_right"

# Displaced commands in select mode
h = "open_below"
j = "search_next"
k = "extend_next_word_end"
l = "find_till_char"       # was on 't' (tilL)
L = "till_prev_char"       # was on 'T' (till backward)
t = "insert_mode"          # was on 'i' (inserT)
T = "insert_at_line_start"  # was on 'I' (Insert at line start)

# Visual mode Space+w: use selection as-is (no line expansion)
[keys.select.space]
w = [":sh echo %{buffer_name} > /tmp/helix-current-file.txt", ":sh echo %{buffer_name} >> /tmp/wiki-nav-history.txt", ":write", ":pipe-to ~/.local/bin/hx-wiki.nu", ":sh sleep 0.1 && hx-wiki-open-smart"]
W = [":sh echo %{buffer_name} > /tmp/helix-current-file.txt", ":sh echo %{buffer_name} >> /tmp/wiki-nav-history.txt", ":write", ":pipe-to ~/.local/bin/hx-wiki.nu", ":sh sleep 0.1", ":sh zellij run --direction right --close-on-exit -- hx-wiki-open-right"]
n = [":sh echo %{buffer_name} > /tmp/helix-current-file.txt", ":sh echo %{buffer_name} >> /tmp/wiki-nav-history.txt", ":write", ":pipe-to ~/.local/bin/hx-wiki.nu", ":sh sleep 0.1", ":sh zellij action new-tab && sleep 0.2 && zellij action write-chars 'hx /tmp/helix-current-link.md' && zellij action write 10"]
