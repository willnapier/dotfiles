// ‚ö†Ô∏è  CLAUDE CODE: THIS FILE IS DOTTER-MANAGED - EDIT HERE IN DOTFILES, NOT ~/.config/zellij/
// ‚ö†Ô∏è  NEVER EDIT ~/.config/zellij/config.kdl - IT'S A SYMLINK TO THIS FILE
// Zellij configuration for Helix + skim integration
// This solves the terminal access issue for interactive fuzzy finders

// Use Alt+l for floating pane link picker  
keybinds {
    normal {
        // Pane navigation with arrow keys (Nav+neio on your Miryoku layout)
        // Arrow keys pass through to applications (Yazi, Helix, etc.)
        // Use Ctrl+p to enter pane mode for arrow key navigation
        
        // Pane focus navigation with Shift+arrow keys (Shift+Nav+neio)
        bind "Shift Left" { MoveFocus "Left"; }
        bind "Shift Down" { MoveFocus "Down"; }
        bind "Shift Up" { MoveFocus "Up"; }
        bind "Shift Right" { MoveFocus "Right"; }

        // Pane movement with Shift+arrow keys (Shift+Nav+neio)
        bind "Ctrl Shift Left" { MovePane "Left"; }
        bind "Ctrl Shift Down" { MovePane "Down"; }
        bind "Ctrl Shift Up" { MovePane "Up"; }
        bind "Ctrl Shift Right" { MovePane "Right"; }
        
        // Resize panes with Ctrl+arrow keys
        bind "Ctrl Left" { Resize "Increase Left"; }
        bind "Ctrl Down" { Resize "Increase Down"; }  
        bind "Ctrl Up" { Resize "Increase Up"; }
        bind "Ctrl Right" { Resize "Increase Right"; }
        
        // Alpha key commands removed from normal mode to prevent typing interference
        // Use Ctrl+p to enter pane mode for pane management (h, v, etc.)
        // Use Ctrl+t to enter tab mode for tab management (j, etc.)
        
        // REMOVED uppercase letter bindings - they steal keystrokes from Helix!
        // Use Ctrl+t for tab mode, Ctrl+p for pane mode instead
        
        // Simple tab switching with Alt+n/o (ColemakDH left/right)
        bind "Alt n" { GoToPreviousTab; }
        bind "Alt o" { GoToNextTab; }
        
        // üî• ALT COMMANDS NUKED üî•
        // Replaced with universal command-line versions:
        // fsh    - file search + open in Helix
        // fwl    - file wiki link + copy to clipboard  
        // fcit   - file citation + copy to clipboard
        // fsem   - file semantic search + copy/open options
        // fsearch- file content search + copy/open options  
        // freplace - find and replace anywhere
        
        // Mode switches - Zellij defaults (preserved)
        bind "Ctrl t" { SwitchToMode "Tab"; }
        bind "Ctrl p" { SwitchToMode "Pane"; }
        bind "Ctrl r" { SwitchToMode "Resize"; }
        bind "Ctrl s" { SwitchToMode "Scroll"; }
        bind "Ctrl o" { SwitchToMode "Session"; }
        bind "Ctrl h" { SwitchToMode "Move"; }
        bind "Ctrl g" { SwitchToMode "Locked"; }
        
        // Quick actions - Zellij defaults (added)
        bind "Ctrl n" { NewPane; }
        bind "Ctrl q" { Quit; }
        // Moved detach to Ctrl+Alt+d to avoid conflict with Helix half-page scroll
        bind "Ctrl Alt d" { Detach; }
        
        // Unbind system theme switcher to let macOS handle it
        unbind "Ctrl Alt Shift d"
    }
    
    // Tab mode with neio navigation (and arrow key fallback)
    tab {
        // neio navigation
        bind "n" { GoToPreviousTab; FocusNextPane; SwitchToMode "Normal"; }
        bind "o" { GoToNextTab; FocusNextPane; SwitchToMode "Normal"; }
        bind "e" { GoToTab 1; FocusNextPane; SwitchToMode "Normal"; }  // first tab + focus
        bind "i" { GoToTab -1; FocusNextPane; SwitchToMode "Normal"; } // last tab + focus
        bind "t" { NewTab; SwitchToMode "Normal"; }
        bind "x" { CloseTab; SwitchToMode "Normal"; }
        
        // Arrow key fallback
        bind "Left" { GoToPreviousTab; FocusNextPane; SwitchToMode "Normal"; }
        bind "Right" { GoToNextTab; FocusNextPane; SwitchToMode "Normal"; }
        bind "Down" { GoToTab 1; FocusNextPane; SwitchToMode "Normal"; }
        bind "Up" { GoToTab -1; FocusNextPane; SwitchToMode "Normal"; }
        
        // Zellij defaults - added
        bind "r" { SwitchToMode "RenameTab"; TabNameInput 0; }
        bind "s" { ToggleActiveSyncTab; SwitchToMode "Normal"; }
        bind "1" { GoToTab 1; SwitchToMode "Normal"; }
        bind "2" { GoToTab 2; SwitchToMode "Normal"; }
        bind "3" { GoToTab 3; SwitchToMode "Normal"; }
        bind "4" { GoToTab 4; SwitchToMode "Normal"; }
        bind "5" { GoToTab 5; SwitchToMode "Normal"; }
        bind "6" { GoToTab 6; SwitchToMode "Normal"; }
        bind "7" { GoToTab 7; SwitchToMode "Normal"; }
        bind "8" { GoToTab 8; SwitchToMode "Normal"; }
        bind "9" { GoToTab 9; SwitchToMode "Normal"; }
        bind "Tab" { ToggleTab; }
        
        // Exit bindings
        bind "Ctrl c" { SwitchToMode "Normal"; }
        bind "Esc" { SwitchToMode "Normal"; }
    }
    
    // Pane mode with neio navigation (and arrow key fallback)
    pane {
        // neio for moving focus
        bind "n" { MoveFocus "Left"; }
        bind "e" { MoveFocus "Down"; }
        bind "i" { MoveFocus "Up"; }
        bind "o" { MoveFocus "Right"; }
        
        // Capital NEIO for creating new panes
        bind "N" { NewPane "Left"; }
        bind "E" { NewPane "Down"; }
        bind "I" { NewPane "Up"; }
        bind "O" { NewPane "Right"; }
        
        // Common operations
        bind "x" { CloseFocus; SwitchToMode "Normal"; }
        bind "f" { ToggleFocusFullscreen; SwitchToMode "Normal"; }
        bind "z" { TogglePaneFrames; SwitchToMode "Normal"; }
        bind "w" { TogglePaneEmbedOrFloating; SwitchToMode "Normal"; }
        
        // Arrow key fallback for focus
        bind "Left" { MoveFocus "Left"; }
        bind "Down" { MoveFocus "Down"; }
        bind "Up" { MoveFocus "Up"; }
        bind "Right" { MoveFocus "Right"; }
        
        // Zellij defaults - added
        bind "r" { SwitchToMode "RenamePane"; PaneNameInput 0; }
        bind "c" { SwitchToMode "Normal"; NewPane; }
        bind "b" { BreakPane; SwitchToMode "Normal"; }  // THE KEY ADDITION - break pane to new tab
        bind "." { NextSwapLayout; }
        bind "," { PreviousSwapLayout; }
        
        // Exit bindings
        bind "Ctrl c" { SwitchToMode "Normal"; }
        bind "Esc" { SwitchToMode "Normal"; }
    }
    
    // Resize mode with neio navigation (and arrow key fallback)
    resize {
        // neio for resizing
        bind "n" { Resize "Decrease Right"; }
        bind "e" { Resize "Increase Down"; }
        bind "i" { Resize "Decrease Down"; }
        bind "o" { Resize "Increase Right"; }
        
        // Capital NEIO for bigger resize steps (3x)
        bind "N" { Resize "Decrease Right"; Resize "Decrease Right"; Resize "Decrease Right"; }
        bind "E" { Resize "Increase Down"; Resize "Increase Down"; Resize "Increase Down"; }
        bind "I" { Resize "Decrease Down"; Resize "Decrease Down"; Resize "Decrease Down"; }
        bind "O" { Resize "Increase Right"; Resize "Increase Right"; Resize "Increase Right"; }
        
        // Arrow key fallback
        bind "Left" { Resize "Decrease Right"; }
        bind "Down" { Resize "Increase Down"; }
        bind "Up" { Resize "Decrease Down"; }
        bind "Right" { Resize "Increase Right"; }
        
        // Zellij defaults - added
        bind "=" { Resize "Increase"; }
        bind "+" { Resize "Increase"; }
        bind "-" { Resize "Decrease"; }
        
        // Exit bindings
        bind "Ctrl c" { SwitchToMode "Normal"; }
        bind "Esc" { SwitchToMode "Normal"; }
    }
    
    // NEW MODES - Scroll mode for buffer navigation and search
    scroll {
        // neio navigation
        bind "e" { ScrollDown; }
        bind "i" { ScrollUp; }
        bind "n" { PageScrollUp; }
        bind "o" { PageScrollDown; }
        
        // Arrow fallback
        bind "Down" { ScrollDown; }
        bind "Up" { ScrollUp; }
        bind "PageDown" { PageScrollDown; }
        bind "PageUp" { PageScrollUp; }
        
        // Zellij defaults - vim-style
        bind "j" { ScrollDown; }
        bind "k" { ScrollUp; }
        bind "g" { ScrollToTop; }
        bind "G" { ScrollToBottom; }
        bind "d" { HalfPageScrollDown; }
        bind "u" { HalfPageScrollUp; }
        bind "Ctrl d" { HalfPageScrollDown; }
        bind "Ctrl u" { HalfPageScrollUp; }
        
        // Search
        bind "s" { SwitchToMode "EnterSearch"; SearchInput 0; }
        bind "Ctrl f" { SwitchToMode "EnterSearch"; SearchInput 0; }
        
        // Exit bindings
        bind "Ctrl c" { SwitchToMode "Normal"; }
        bind "Esc" { SwitchToMode "Normal"; }
        bind "Enter" { SwitchToMode "Normal"; }
        bind "Space" { SwitchToMode "Normal"; }
    }
    
    // NEW MODES - Search mode
    search {
        bind "n" { Search "down"; }
        bind "p" { Search "up"; }
        bind "N" { Search "up"; }
        bind "P" { Search "down"; }
        bind "c" { SearchToggleOption "CaseSensitivity"; }
        bind "w" { SearchToggleOption "Wrap"; }
        bind "o" { SearchToggleOption "WholeWord"; }
        
        bind "Ctrl c" { SwitchToMode "Scroll"; }
        bind "Esc" { SwitchToMode "Scroll"; }
        bind "Enter" { SwitchToMode "Normal"; }
    }
    
    // NEW MODES - Move mode for moving panes between tabs  
    move {
        bind "n" { MovePane; }
        bind "p" { MovePaneBackwards; }
        bind "h" { MovePane "Left"; }
        bind "j" { MovePane "Down"; }
        bind "k" { MovePane "Up"; }
        bind "l" { MovePane "Right"; }
        bind "t" { BreakPane; SwitchToMode "Normal"; }  // Move to new tab
        
        bind "Ctrl c" { SwitchToMode "Normal"; }
        bind "Esc" { SwitchToMode "Normal"; }
    }
    
    // NEW MODES - Session mode
    session {
        bind "d" { Detach; }
        bind "w" { 
            LaunchOrFocusPlugin "session-manager" {
                floating true
            }
        }
        bind "c" {
            LaunchOrFocusPlugin "session-manager" {
                floating true
                move_to_focused_tab true
            }
        }
        
        bind "Ctrl c" { SwitchToMode "Normal"; }
        bind "Esc" { SwitchToMode "Normal"; }
    }
    
    // NEW MODES - Locked mode (help)
    locked {
        bind "Ctrl g" { SwitchToMode "Normal"; }
    }
}

// Theme configuration to match system (auto-switched)
theme "solarized-dark"

// Define Solarized themes for consistent theming
themes {
    solarized-dark {
        fg 147 161 161      // base0
        bg 0 43 54          // base03
        black 7 54 66       // base02
        red 220 50 47       // red
        green 133 153 0     // green
        yellow 181 137 0    // yellow
        blue 38 139 210     // blue
        magenta 211 54 130  // magenta
        cyan 42 161 152     // cyan
        white 238 232 213   // base2
        orange 203 75 22    // orange
        // Status bar mode indicator colors (the grey you're looking for!)
        ribbon_selected {
            base 147 161 161      // base0 - active mode text (bright)
            background 0 43 54    // base03 - active mode background
        }
        ribbon_unselected {
            base 88 110 117       // base01 - inactive mode text (grey)
            background 7 54 66    // base02 - inactive mode background
        }
        // Enhanced pane frame colors for better focus visibility
        frame 38 139 210         // blue - focused pane border (much more visible)
        frame_inactive 88 110 117   // base01 - inactive pane border (dimmer)
    }
    
    solarized-light {
        fg 101 123 131      // base00
        bg 253 246 227      // base3
        black 7 54 66       // base02
        red 220 50 47       // red
        green 133 153 0     // green
        yellow 181 137 0    // yellow
        blue 38 139 210     // blue
        magenta 211 54 130  // magenta
        cyan 42 161 152     // cyan
        white 238 232 213   // base2
        orange 203 75 22    // orange
        // Status bar mode indicator colors (the grey you're looking for!)
        ribbon_selected {
            base 101 123 131      // base00 - active mode text (dark)
            background 253 246 227  // base3 - active mode background
        }
        ribbon_unselected {
            base 147 161 161       // base0 - inactive mode text (grey)
            background 238 232 213  // base2 - inactive mode background
        }
        // Enhanced pane frame colors for better focus visibility
        frame 38 139 210         // blue - focused pane border (much more visible)
        frame_inactive 147 161 161  // base0 - inactive pane border (subtle for light mode)
    }
}

// General settings - Use Nushell as default shell (platform-specific path)  
default_shell "nu"

// Environment variables for proper terminal detection
// Commented out to let WezTerm's native TERM pass through to Nushell
// This fixes cursor position report issues (^[[34;33R) in table output
// env {
//     TERM "xterm-256color"
// }

// Copy/paste configuration - disabled to prevent conflict with WezTerm clipboard handling
// copy_command "pbcopy"
// copy_clipboard "system" 
// copy_on_select true

// Mouse support for better selection and scrolling
mouse_mode true
scroll_buffer_size 10000

// Pane settings
pane_frames true
simplified_ui false

// Plugin settings - tab-bar removed to prevent duplicate mode indicators
plugins {
    status-bar { path "status-bar"; }
}

// Layout settings - Uses screen-aware selection via zj script
default_layout "default"

// Session settings - Workaround for known Zellij zombie session bugs
// See: https://github.com/zellij-org/zellij/issues/3918 (zombie sessions)
//      https://github.com/zellij-org/zellij/issues/1625 (memory leaks)
session_serialization true       // Keep useful features despite bugs
pane_viewport_serialization true // Keep layout restoration
scrollback_lines_to_serialize 2000 // Conservative limit for speed/responsiveness

// Auto-attach disabled - prevents some memory leak triggers
attach_to_session false
